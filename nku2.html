<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NKU — AI Skills Demand (OH/KY Executive View)</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* ==========================================================
       NKU Brand Theme (Light Mode)
       - White background + dark text
       - NKU Gold accents + clean modern UI
       - Easy-to-read, well-grouped CSS
       ========================================================== */
    
    /* ---------- NKU Brand Tokens ---------- */
    :root{
      /* Core */
      --bg: #ffffff;
      --text: #111827;        /* slate-900 */
      --muted: #4b5563;       /* slate-600 */
      --muted2:#6b7280;       /* slate-500 */
    
      /* NKU-inspired accents (Gold + Black + Neutral blues) */
      --nku-gold: #FFC72C;    /* NKU Gold */
      --nku-black:#0b0f14;    /* near-black */
      --accent: #0F172A;      /* deep slate for buttons/headings */
      --accent2:#1d4ed8;      /* optional link/secondary accent */
    
      /* Surfaces + borders */
      --surface: #ffffff;
      --surface2:#f8fafc;     /* slate-50 */
      --surface3:#f1f5f9;     /* slate-100 */
      --border: #e5e7eb;      /* gray-200 */
      --border2:#d1d5db;      /* gray-300 */
    
      /* Feedback */
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
    
      /* Effects */
      --shadow: 0 14px 40px rgba(15, 23, 42, 0.10);
      --shadow2: 0 10px 24px rgba(15, 23, 42, 0.08);
    
      /* Radii + layout */
      --r: 18px;
      --r2: 24px;
      --max: 1240px;
    }
    
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial;
      color: var(--text);
      background: var(--bg);
      line-height: 1.55;
    }
    
    /* ---------- Links ---------- */
    a{
      color: var(--accent2);
      text-decoration: none;
      font-weight: 800;
    }
    a:hover{ text-decoration: underline; }
    
    /* ---------- Page Wrapper ---------- */
    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 18px 18px 46px;
    }
    
    /* ==========================================================
       Header / Top Bar
       ========================================================== */
    header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 14px 0;
    }
    
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 260px;
    }
    
    .mark{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background:
        radial-gradient(14px 14px at 30% 30%, rgba(255,255,255,.8), transparent 55%),
        linear-gradient(145deg, var(--nku-gold), #ffd86b);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 10px 24px rgba(255, 199, 44, 0.22);
    }
    
    .brand h1{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: .01em;
      color: var(--nku-black);
    }
    .brand p{
      margin:0;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
    }
    
    /* ---------- Nav / Controls ---------- */
    .nav{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    
    /* Segmented controls */
    .seg{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 5px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      box-shadow: var(--shadow2);
    }
    
    .seg button{
      border: 0;
      cursor: pointer;
      background: transparent;
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 950;
      color: var(--muted);
      transition: transform .08s ease, background .15s ease, color .15s ease;
      white-space: nowrap;
    }
    
    .seg button:hover{
      color: var(--text);
      transform: translateY(-1px);
    }
    
    .seg button[aria-pressed="true"]{
      color: var(--nku-black);
      background: linear-gradient(180deg, rgba(255,199,44,.55), rgba(255,199,44,.22));
      border: 1px solid rgba(255,199,44,.55);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.05);
    }
    
    /* Status chips */
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      box-shadow: var(--shadow2);
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      white-space: nowrap;
    }
    .chip strong{ color: var(--text); }
    
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--good);
      box-shadow: 0 0 0 6px rgba(22,163,74,.12);
    }
    
    /* Buttons */
    .btn{
      cursor:pointer;
      border: 1px solid var(--border2);
      background: var(--surface);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 950;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, filter .15s ease, background .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(0px); }
    
    .btn.primary{
      border-color: rgba(255,199,44,.75);
      background: linear-gradient(180deg, rgba(255,199,44,.95), rgba(255,199,44,.70));
      color: var(--nku-black);
      box-shadow: 0 16px 34px rgba(255, 199, 44, 0.25);
    }
    
    /* ==========================================================
       Layout + Cards
       ========================================================== */
    main{ padding-top: 18px; }
    
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }
    .span-12{ grid-column: span 12; }
    .span-8{ grid-column: span 8; }
    .span-6{ grid-column: span 6; }
    .span-4{ grid-column: span 4; }
    .span-3{ grid-column: span 3; }
    
    .card{
      border-radius: var(--r2);
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    
    .hd{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    
    .hd h2{
      margin:0;
      font-size: 14px;
      font-weight: 950;
      letter-spacing: .01em;
      color: var(--nku-black);
    }
    
    .hd p{
      margin: 6px 0 0;
      font-size: 12.5px;
      font-weight: 800;
      color: var(--muted);
      max-width: 980px;
    }
    
    .bd{ padding: 14px 16px 16px; }
    
    /* ==========================================================
       Hero
       ========================================================== */
    .hero{
      padding: 18px 16px;
      background:
        radial-gradient(900px 260px at 18% 0%, rgba(255,199,44,.28), transparent 60%),
        radial-gradient(900px 260px at 80% 0%, rgba(29,78,216,.10), transparent 60%);
    }
    
    .heroTitle{
      margin:0;
      font-size: 28px;
      font-weight: 1000;
      letter-spacing:-.02em;
      color: var(--nku-black);
      line-height: 1.1;
    }
    
    .heroSub{
      margin: 10px 0 0;
      font-size: 13.5px;
      font-weight: 800;
      color: var(--muted);
      max-width: 980px;
    }
    
    .heroStrip{
      margin-top: 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface2);
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      white-space: nowrap;
    }
    
    .pill strong{ color: var(--text); }
    
    .pill .kbd{
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,199,44,.65);
      background: rgba(255,199,44,.22);
      font-weight: 950;
      color: var(--nku-black);
    }
    
    /* ==========================================================
       KPI Tiles
       ========================================================== */
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }
    
    .kpi{
      border-radius: var(--r);
      border: 1px solid var(--border);
      background: var(--surface);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow2);
    }
    
    .kpiLabel{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      font-weight: 950;
      color: var(--muted);
      letter-spacing:.01em;
    }
    
    .kpiVal{
      margin-top: 8px;
      font-size: 28px;
      font-weight: 1000;
      letter-spacing:-.02em;
      line-height: 1.05;
      color: var(--nku-black);
    }
    
    .kpiSub{
      margin-top: 8px;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted2);
    }
    
    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: var(--surface3);
      font-size: 11px;
      font-weight: 950;
      color: var(--muted);
      white-space: nowrap;
    }
    .tag.good{
      border-color: rgba(22,163,74,.30);
      background: rgba(22,163,74,.10);
      color: rgba(20,83,45,.98);
    }
    .tag.warn{
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.14);
      color: rgba(120,53,15,.98);
    }
    
    .note{
      margin-top: 10px;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted2);
    }
    
    /* ==========================================================
       Charts + Lists
       ========================================================== */
    .chartWrap{
      border-radius: var(--r);
      border: 1px solid var(--border);
      background: var(--surface2);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    
    .chartBox{ height: 360px; padding: 10px 10px 6px; }
    .chartBoxTall{ height: 420px; padding: 10px 10px 6px; }
    
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .list{
      margin: 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    
    .li{
      border: 1px solid var(--border);
      background: var(--surface2);
      border-radius: 16px;
      padding: 10px 10px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
      font-size: 13px;
      font-weight: 900;
      color: var(--nku-black);
    }
    
    .li span{
      color: var(--muted);
      font-weight: 950;
      white-space: nowrap;
    }
    
    .li small{
      display:block;
      margin-top: 3px;
      color: var(--muted2);
      font-weight: 800;
      font-size: 11.5px;
    }
    
    /* ==========================================================
       Drawer (Right Panel)
       ========================================================== */
    .drawer{
      position: fixed;
      top: 14px;
      right: 14px;
      width: min(720px, calc(100vw - 28px));
      height: calc(100vh - 28px);
      border-radius: 26px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 30px 80px rgba(15,23,42,.20);
      transform: translateX(calc(100% + 18px));
      transition: transform .22s ease;
      z-index: 100;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }
    
    .dh{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
    }
    
    .dh h3{
      margin:0;
      font-size: 15px;
      font-weight: 950;
      letter-spacing: .01em;
      color: var(--nku-black);
    }
    
    .dh .sub{
      margin-top:4px;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
    }
    
    .db{
      padding: 12px 14px 16px;
      overflow:auto;
    }
    
    .section{ margin-bottom: 14px; }
    
    .section p{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 13px;
      font-weight: 800;
      line-height: 1.55;
    }
    
    .section ul{
      margin: 8px 0 0 18px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 800;
      line-height: 1.55;
    }
    
    pre{
      margin: 10px 0 0;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--surface3);
      color: var(--nku-black);
      font-size: 12px;
      overflow:auto;
    }
    
    code{
      padding: 1px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,199,44,.60);
      background: rgba(255,199,44,.20);
      color: var(--nku-black);
      font-weight: 950;
    }
    
    /* ==========================================================
       Loading Skeleton
       ========================================================== */
    .skel{
      display:inline-block;
      border-radius: 14px;
      background: linear-gradient(90deg, rgba(17,24,39,.05), rgba(17,24,39,.12), rgba(17,24,39,.05));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite;
    }
    @keyframes shimmer{
      0%{ background-position:200% 0; }
      100%{ background-position:-200% 0; }
    }
    
    /* ==========================================================
       Responsive
       ========================================================== */
    @media (max-width: 1020px){
      .topbar{ flex-direction:column; align-items:stretch; }
      .nav{ justify-content:flex-start; }
      .brand{ min-width:0; }
      .heroTitle{ font-size: 26px; }
      .split{ grid-template-columns:1fr; }
      .chartBox{ height: 380px; }
      .chartBoxTall{ height: 460px; }
    }
    @media (max-width: 820px){
      .span-8, .span-6, .span-4, .span-3{ grid-column: span 12; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <h1>NKU · AI Skills Demand (OH/KY)</h1>
          <p>Executive-ready signal dashboard · curriculum + employer outreach</p>
        </div>
      </div>

      <div class="nav">
        <div class="seg" role="group" aria-label="State filter">
          <button type="button" data-state="BOTH" aria-pressed="true">OH+KY</button>
          <button type="button" data-state="OH" aria-pressed="false">Ohio</button>
          <button type="button" data-state="KY" aria-pressed="false">Kentucky</button>
        </div>

        <span class="chip"><span class="dot" aria-hidden="true"></span> Status: <strong id="status">loading…</strong></span>
        <span class="chip">Last refresh: <strong id="lastRefresh">—</strong></span>
        <button class="btn" id="openMethods" type="button">Methods & Sources</button>
        <button class="btn primary" id="forceRefresh" type="button">Force refresh</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <!-- HERO -->
    <section class="grid" aria-label="Hero">
      <div class="card span-12">
        <div class="bd hero">
          <h2 class="heroTitle">What AI skills should NKU be teaching right now?</h2>
          <p class="heroSub">
            This view is optimized for decisions: it focuses on <strong>skills</strong> (what to teach) and <strong>employers</strong> (who to partner with)
            using a transparent “AI-signal” filter on a regional sample from <strong>Ohio</strong> and <strong>Kentucky</strong>.
          </p>

          <div class="heroStrip">
            <div class="pill"><span class="kbd">1</span> Start with <strong>Top Skills</strong> (regional AI-signal postings)</div>
            <div class="pill"><span class="kbd">2</span> Validate with <strong>Rising Skills</strong> (momentum)</div>
            <div class="pill"><span class="kbd">3</span> Target <strong>Top Employers</strong> for projects + internships</div>
            <div class="pill"><span class="kbd">4</span> Use <strong>Role Families</strong> to place skills in curriculum context</div>
          </div>
        </div>
      </div>
    </section>

    <!-- KPI STRIP (only the most decision-useful ones) -->
    <section class="grid" style="margin-top:14px" aria-label="Key metrics">
      <div class="card span-12">
        <div class="hd">
          <div>
            <h2>Decision KPIs (regional sample → AI-signal subset)</h2>
            <p>These are the only KPIs shown because they directly support curriculum planning and employer outreach.</p>
          </div>
          <button class="btn" id="openInterpret" type="button">How to interpret</button>
        </div>

        <div class="bd">
          <div class="kpiRow">
            <div class="kpi span-3">
              <div class="kpiLabel">
                Regional sample size (pre-filter)
                <span class="tag" id="kPagesTag">5 pages/state/source</span>
              </div>
              <div class="kpiVal" id="kRegionalTotal"><span class="skel" style="width:120px;height:32px"></span></div>
              <div class="kpiSub">Total OH/KY postings returned before AI filtering (deduped)</div>
            </div>

            <div class="kpi span-3">
              <div class="kpiLabel">
                AI-signal postings (subset)
                <span class="tag good" id="kAiTag">AI-signal</span>
              </div>
              <div class="kpiVal" id="kAiTotal"><span class="skel" style="width:110px;height:32px"></span></div>
              <div class="kpiSub">Postings that include AI signals (transparent keyword filter)</div>
            </div>

            <div class="kpi span-3">
              <div class="kpiLabel">
                AI-signal share of regional sample
                <span class="tag" id="kShareTag">directional</span>
              </div>
              <div class="kpiVal" id="kAiShare"><span class="skel" style="width:90px;height:32px"></span></div>
              <div class="kpiSub">Helps answer “how quickly AI expectations are showing up regionally”</div>
            </div>

            <div class="kpi span-3">
              <div class="kpiLabel">
                Date coverage (data quality)
                <span class="tag warn" id="kDateTag">matters for momentum</span>
              </div>
              <div class="kpiVal" id="kDateCoverage"><span class="skel" style="width:90px;height:32px"></span></div>
              <div class="kpiSub">Higher coverage → more reliable “Rising Skills” signal</div>
            </div>
          </div>

          <div class="note">
            Tip: If the sample feels small, increase per-page counts or pages—but watch rate limits. (Open Methods for settings.)
          </div>
        </div>
      </div>
    </section>

    <!-- TOP SKILLS + RISING SKILLS -->
    <section class="grid" style="margin-top:14px" aria-label="Skills">
      <div class="card span-8">
        <div class="hd">
          <div>
            <h2>Top AI Skill Signals (what to teach)</h2>
            <p>Counts of skill phrases found in OH/KY AI-signal postings. This is the primary curriculum input.</p>
          </div>
          <button class="btn" id="openSkillMap" type="button">Skill map</button>
        </div>
        <div class="bd">
          <div class="chartWrap">
            <div class="chartBoxTall">
              <canvas id="topSkillsChart" aria-label="Top skills chart"></canvas>
            </div>
          </div>
          <div class="note">Use this list for: module priorities, micro-credentials, and applied project skill requirements.</div>
        </div>
      </div>

      <div class="card span-4">
        <div class="hd">
          <div>
            <h2>Rising Skills (momentum)</h2>
            <p>Skills with the biggest uplift in recent postings vs earlier ones (when dates are available).</p>
          </div>
          <button class="btn" id="openMomentum" type="button">Momentum logic</button>
        </div>
        <div class="bd">
          <ul class="list" id="risingSkillsList">
            <li class="li"><div><span class="skel" style="width:220px;height:18px"></span><small><span class="skel" style="width:180px;height:14px"></span></small></div><span class="skel" style="width:48px;height:18px"></span></li>
            <li class="li"><div><span class="skel" style="width:200px;height:18px"></span><small><span class="skel" style="width:150px;height:14px"></span></small></div><span class="skel" style="width:48px;height:18px"></span></li>
            <li class="li"><div><span class="skel" style="width:210px;height:18px"></span><small><span class="skel" style="width:170px;height:14px"></span></small></div><span class="skel" style="width:48px;height:18px"></span></li>
            <li class="li"><div><span class="skel" style="width:190px;height:18px"></span><small><span class="skel" style="width:140px;height:14px"></span></small></div><span class="skel" style="width:48px;height:18px"></span></li>
            <li class="li"><div><span class="skel" style="width:205px;height:18px"></span><small><span class="skel" style="width:160px;height:14px"></span></small></div><span class="skel" style="width:48px;height:18px"></span></li>
          </ul>
          <div class="note" id="momentumNote">If date coverage is low, this section becomes “limited / directional.”</div>
        </div>
      </div>
    </section>

    <!-- EMPLOYERS + ROLE FAMILIES -->
    <section class="grid" style="margin-top:14px" aria-label="Employers and role families">
      <div class="card span-4">
        <div class="hd">
          <div>
            <h2>Top Employers Posting AI-Signal Roles</h2>
            <p>Targets for outreach: internships, capstone projects, sponsored challenges, advisory support.</p>
          </div>
          <button class="btn" id="openEmployerNotes" type="button">Outreach playbook</button>
        </div>
        <div class="bd">
          <ul class="list" id="topEmployersList"></ul>
          <div class="note">Use the top 10 list for immediate outreach + partnership prioritization.</div>
        </div>
      </div>

      <div class="card span-8">
        <div class="hd">
          <div>
            <h2>Role Families Using AI (context for curriculum)</h2>
            <p>Exec-stable grouping of AI-signal postings (AI/ML, Data, Software, Cyber, Business/Operations, etc.).</p>
          </div>
          <button class="btn" id="openRoleNotes" type="button">Category logic</button>
        </div>
        <div class="bd">
          <div class="chartWrap">
            <div class="chartBox">
              <canvas id="roleFamiliesChart" aria-label="Role families chart"></canvas>
            </div>
          </div>
          <div class="note">This helps NKU decide where to “embed” AI skills: core courses vs electives vs certificates.</div>
        </div>
      </div>
    </section>

    <!-- OPTIONAL: QUICK RECOMMENDATIONS (auto-generated from current state/lens) -->
    <section class="grid" style="margin-top:14px" aria-label="Recommendations">
      <div class="card span-12">
        <div class="hd">
          <div>
            <h2>What NKU should do next (auto-generated)</h2>
            <p>Quick, practical actions based on the current OH/KY signals shown above.</p>
          </div>
          <button class="btn" id="openActionsWhy" type="button">Why these actions</button>
        </div>
        <div class="bd">
          <div class="split">
            <div class="li" style="display:block;">
              <div id="rec1Title">—</div>
              <small id="rec1Body">—</small>
            </div>
            <div class="li" style="display:block;">
              <div id="rec2Title">—</div>
              <small id="rec2Body">—</small>
            </div>
            <div class="li" style="display:block;">
              <div id="rec3Title">—</div>
              <small id="rec3Body">—</small>
            </div>
            <div class="li" style="display:block;">
              <div id="rec4Title">—</div>
              <small id="rec4Body">—</small>
            </div>
          </div>

          <div class="note">
            These actions are meant to be copied into a one-pager for chairs/directors (skills → courses → partners → student work).
          </div>
        </div>
      </div>
    </section>

  </div>
</main>

<aside class="drawer" id="drawer" role="dialog" aria-modal="false" aria-label="Drawer">
  <div class="dh">
    <div>
      <h3 id="drawerTitle">Details</h3>
      <div class="sub" id="drawerSub">—</div>
    </div>
    <button class="btn" id="drawerClose" type="button">Close</button>
  </div>
  <div class="db" id="drawerBody"></div>
</aside>

<script>
/* ==========================================================
   NKU OH/KY Executive Dashboard (Skills-First Edition)
   - Modern "wow" design, glass + gradients
   - Only decision-useful KPIs: sample size, AI subset, AI share, date coverage
   - Core modules: Top Skills, Rising Skills, Top Employers, Role Families, Actions
   - Uses your existing Worker (same endpoints)
   ========================================================== */

/*** CONFIG ***/
const PROXY_BASE = "https://ai-skills-proxy.nealb3.workers.dev";
const CACHE_KEY = "nku_ohky_skills_first_v1";
const CACHE_TTL_MS = 60 * 60 * 1000; // 1 hour

const REGION_PAGES = 5;
const ADZUNA_PER_PAGE = 50;
const USAJOBS_PER_PAGE = 50;

const AI_TERMS = [
  "artificial intelligence","machine learning","generative ai","genai","llm",
  "large language model","chatgpt","copilot","prompt","prompting","rag",
  "embedding","vector database","computer vision","nlp"
];

// Academic lenses (kept, but only used to refine which postings contribute to the skills/employer signals)
const AUDIENCE_FILTERS = {
  all: () => true,
  business: (job) => /(analyst|finance|account|marketing|operations|product|strategy|business|supply|procurement|risk|audit)/i
    .test(asText(job.title) + " " + asText(job.description)),
  informatics: (job) => /(engineer|developer|software|data scientist|ml|ai|cloud|devops|security|cyber|architect|platform|systems|network)/i
    .test(asText(job.title) + " " + asText(job.description)),
  health: (job) => /(health|clinical|patient|hospital|medical|biostat|epidemi|informatics|care|nursing|pharma|imaging)/i
    .test(asText(job.title) + " " + asText(job.description)),
};

// Transparent skill map (edit freely)
const SKILLS = [
  { skill:"AI tools (Copilot/ChatGPT)", family:"GenAI tools", keys:["copilot","chatgpt","assistant"] },
  { skill:"Prompting & workflow design", family:"GenAI workflows", keys:["prompt","prompting","agent","agentic","orchestration","workflow"] },
  { skill:"LLM app development (RAG)", family:"GenAI engineering", keys:["llm","rag","retrieval","vector","embedding","langchain","prompt engineering"] },
  { skill:"Responsible AI / ethics", family:"Governance", keys:["responsible ai","ethics","fairness","bias","governance","policy","compliance"] },
  { skill:"Privacy (PII/PHI)", family:"Trust", keys:["privacy","pii","phi","gdpr","hipaa","data protection"] },
  { skill:"Security (AI + data)", family:"Trust", keys:["security","infosec","soc","zero trust","iam","identity","access","vulnerability","threat"] },
  { skill:"SQL / BI dashboards", family:"Data foundations", keys:["sql","power bi","tableau","dashboard","analytics","reporting"] },
  { skill:"Data engineering", family:"Data foundations", keys:["data engineer","pipeline","warehouse","lakehouse","spark","dbt","etl"] },
  { skill:"Python", family:"Automation", keys:["python","scripting"] },
  { skill:"Cloud platforms", family:"Engineering", keys:["aws","azure","gcp","cloud","kubernetes","docker"] },
  { skill:"Process improvement / automation", family:"Automation", keys:["process improvement","automation","rpa","lean","six sigma","kaizen"] },
];

/*** DOM ***/
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
function setText(sel, txt){ const el = $(sel); if(el) el.textContent = txt; }

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function asText(v){
  if(v == null) return "";
  if(Array.isArray(v)) return v.filter(Boolean).join(" ");
  if(typeof v === "string") return v;
  if(typeof v === "number" || typeof v === "boolean") return String(v);
  try { return JSON.stringify(v); } catch { return String(v); }
}
function fmt(n){ return (n ?? 0).toLocaleString(); }

/*** CACHE ***/
function readCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(Date.now() - obj.time > CACHE_TTL_MS) return null;
    return obj.data;
  }catch{ return null; }
}
function writeCache(data){
  try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), data })); }catch{}
}
function clearCache(){
  try{ localStorage.removeItem(CACHE_KEY); }catch{}
}

/*** FETCH HELPERS ***/
async function fetchJson(url){
  const res = await fetch(url, { cache:"no-store" });
  const text = await res.text();
  let json;
  try{ json = JSON.parse(text); }catch{
    throw new Error("Non-JSON from " + url + ": " + text.slice(0,200));
  }
  if(!res.ok){
    const msg = json?.error || json?.message || ("HTTP " + res.status);
    throw new Error(url + " → " + msg);
  }
  return json;
}

async function fetchUSAJOBSRegion(stateName, perPage=50, page=1){
  const loc = encodeURIComponent(stateName);
  const url = `${PROXY_BASE}/usajobs?ResultsPerPage=${perPage}&Page=${page}&LocationName=${loc}`;
  return { url, json: await fetchJson(url) };
}
async function fetchAdzunaRegion(stateName, perPage=50, page=1){
  const where = encodeURIComponent(stateName);
  const url = `${PROXY_BASE}/adzuna?results_per_page=${perPage}&page=${page}&country=us&where=${where}`;
  return { url, json: await fetchJson(url) };
}

/*** NORMALIZERS ***/
function parseDateSafe(x){
  if(!x) return null;
  const d = new Date(x);
  if(Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}
function normalizeUSAJOBS(payload){
  const items = payload?.SearchResult?.SearchResultItems || [];
  return items.map(it=>{
    const d = it?.MatchedObjectDescriptor || {};
    const details = d?.UserArea?.Details || {};
    const cats = (d?.JobCategory || []).map(c=>c?.Name).filter(Boolean);
    const dateRaw = d?.PublicationStartDate || d?.PositionStartDate || d?.ApplicationCloseDate || null;

    const duties = asText(details?.MajorDuties);
    const summary = asText(details?.JobSummary);
    const desc = duties || summary;

    return {
      source: "USAJOBS",
      title: asText(d?.PositionTitle),
      description: desc,
      company: asText(d?.OrganizationName || d?.DepartmentName || "Federal"),
      category: asText(cats[0] || d?.DepartmentName || "Federal"),
      location: asText((d?.PositionLocation || [])[0]?.LocationName || ""),
      url: asText(d?.PositionURI || ""),
      date: parseDateSafe(dateRaw)
    };
  });
}
function normalizeAdzuna(payload){
  const items = payload?.results || [];
  return items.map(it=>({
    source: "Adzuna",
    title: asText(it?.title),
    description: asText(it?.description),
    company: asText(it?.company?.display_name || "Unknown"),
    category: asText(it?.category?.label || "Other"),
    location: asText(it?.location?.display_name || ""),
    url: asText(it?.redirect_url || it?.adref || ""),
    date: parseDateSafe(it?.created || it?.created_at || it?.publication_date || null)
  }));
}
function dedupeJobs(jobs){
  const seen = new Set();
  const out = [];
  for(const j of jobs){
    const key = (asText(j.url) || `${asText(j.source)}|${asText(j.company)}|${asText(j.title)}|${asText(j.location)}`)
      .toLowerCase().trim();
    if(seen.has(key)) continue;
    seen.add(key);
    out.push(j);
  }
  return out;
}

/*** MULTI-PAGE FETCH ***/
async function fetchPages(pages, perPage, pageFetchFn, normalizer){
  const all = [];
  const debug = [];
  const settled = await Promise.allSettled(
    Array.from({length: pages}, (_,i)=> pageFetchFn(perPage, i+1))
  );
  for(const r of settled){
    if(r.status === "fulfilled"){
      debug.push({ ok:true, url: r.value.url });
      all.push(...normalizer(r.value.json));
    } else {
      debug.push({ ok:false, error:String(r.reason).slice(0,200) });
    }
  }
  const deduped = dedupeJobs(all);
  return { jobs: deduped, rawCount: all.length, debug };
}

/*** SIGNALS ***/
function aiSignalMatch(job){
  const text = (asText(job.title) + " " + asText(job.description)).toLowerCase();
  return AI_TERMS.some(t => text.includes(String(t).toLowerCase()));
}
function skillCounts(jobs){
  const counts = new Map();
  for(const s of SKILLS) counts.set(s.skill, 0);
  for(const j of jobs){
    const text = (asText(j.title) + " " + asText(j.description)).toLowerCase();
    for(const s of SKILLS){
      if(s.keys.some(k => text.includes(String(k).toLowerCase()))){
        counts.set(s.skill, (counts.get(s.skill)||0) + 1);
      }
    }
  }
  return counts;
}
function topNFromMap(m, n=10){
  return [...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n);
}
function companyCounts(jobs){
  const m = new Map();
  for(const j of jobs){
    const c = (asText(j.company) || "Unknown").trim() || "Unknown";
    m.set(c, (m.get(c)||0) + 1);
  }
  return m;
}

/*** ROLE FAMILY (exec-stable) ***/
function normalizeCategoryName(raw){
  const s = (raw ?? "").toString().trim();
  if(!s) return "Other";
  return s.replace(/\s+/g, " ").trim();
}
function textBlob(job){
  return `${asText(job.title)} ${asText(job.category)} ${asText(job.company)} ${asText(job.location)} ${asText(job.description)}`.toLowerCase();
}
function roleFamily(job){
  const blob = textBlob(job);

  if (/\b(ai|artificial intelligence|machine learning|ml|llm|genai|generative ai|nlp|computer vision|rag|embedding|vector)\b/.test(blob)) return "AI / ML";
  if (/\b(data analyst|data analytics|analytics|bi\b|sql\b|power bi|tableau|dashboard|reporting|data warehouse|etl|dbt|spark|lakehouse|data engineer)\b/.test(blob)) return "Data & Analytics";
  if (/\b(devops|sre|site reliability|kubernetes|docker|ci\/cd|terraform|cloud infrastructure)\b/.test(blob)) return "DevOps / Cloud";
  if (/\b(software|developer|engineer|full[- ]stack|frontend|backend|mobile|web developer|api\b|typescript|javascript|java\b|c\+\+|c#|python\b|golang|rust)\b/.test(blob)) return "Software Development";
  if (/\b(cyber|security|infosec|soc\b|zero trust|iam\b|identity|access|vulnerability|penetration|siem|risk|compliance)\b/.test(blob)) return "Cybersecurity / IT";
  if (/\b(product manager|product management|project manager|program manager|scrum|agile|product owner|pm\b)\b/.test(blob)) return "Product / Project";
  if (/\b(business analyst|operations|strategy|process improvement|continuous improvement|lean\b|six sigma|supply chain|procurement|finance|accounting)\b/.test(blob)) return "Business / Operations";
  if (/\b(marketing|growth|seo\b|content|brand|demand gen|sales|account executive|customer success|support|client)\b/.test(blob)) return "Marketing / Sales";
  if (/\b(health|clinical|patient|hospital|medical|biostat|epidemi|pharma|nursing)\b/.test(blob)) return "Health / Clinical";
  if (/\b(instructor|trainer|curriculum|learning|education|teaching)\b/.test(blob)) return "Education / Training";

  return "Other";
}

/*** MOMENTUM (Rising Skills) ***/
function splitRecentEarlier(jobs, recentDays=30, earlierDays=120){
  // Recent: last N days; Earlier: N..earlierDays
  const now = Date.now();
  const recentMs = recentDays * 24 * 3600 * 1000;
  const earlierMs = earlierDays * 24 * 3600 * 1000;

  const dated = jobs.filter(j => !!j.date && !Number.isNaN(new Date(j.date).getTime()));
  const recent = [];
  const earlier = [];

  for(const j of dated){
    const t = new Date(j.date).getTime();
    const age = now - t;
    if(age <= recentMs) recent.push(j);
    else if(age <= earlierMs) earlier.push(j);
  }
  return { datedCount: dated.length, recent, earlier };
}
function risingSkills(jobs){
  const { datedCount, recent, earlier } = splitRecentEarlier(jobs, 30, 120);

  const recentCounts = skillCounts(recent);
  const earlierCounts = skillCounts(earlier);

  // normalized uplift: (recent rate - earlier rate) where rate = mentions / max(1, jobs in bucket)
  const rDen = Math.max(1, recent.length);
  const eDen = Math.max(1, earlier.length);

  const rows = SKILLS.map(s=>{
    const r = (recentCounts.get(s.skill)||0) / rDen;
    const e = (earlierCounts.get(s.skill)||0) / eDen;
    return { skill: s.skill, rRate: r, eRate: e, delta: r - e, rMentions: (recentCounts.get(s.skill)||0), eMentions: (earlierCounts.get(s.skill)||0) };
  }).sort((a,b)=> b.delta - a.delta);

  return { datedCount, recentCount: recent.length, earlierCount: earlier.length, rows: rows.slice(0,5) };
}

/*** STATE ***/
let dashboard = null;
let currentState = "BOTH";   // BOTH | OH | KY
let currentAudience = "all"; // all | business | informatics | health

/*** CHARTS ***/
let topSkillsChart = null;
let roleFamiliesChart = null;

function renderSkillsChart(labels, values){
  const canvas = $("#skillsChart");
  if(!canvas) return;

  if(skillsChart) skillsChart.destroy();

  // Sort highest → lowest (better story)
  const pairs = labels.map((l,i)=>[l, values[i] ?? 0]).sort((a,b)=>b[1]-a[1]);
  const sortedLabels = pairs.map(p=>p[0]);
  const sortedValues = pairs.map(p=>p[1]);

  // Shorten labels for axis display (full label stays in tooltip)
  const shortLabel = (s, max=26) => {
    const t = String(s ?? "");
    if(t.length <= max) return t;
    return t.slice(0, max-1) + "…";
  };

  const total = sortedValues.reduce((s,v)=>s+v,0) || 1;

  skillsChart = new Chart(canvas, {
    type: "bar",
    data: {
      labels: sortedLabels.map(l => shortLabel(l, 30)),
      datasets: [{
        label: "Mentions",
        data: sortedValues,

        // NKU-friendly gold
        backgroundColor: "rgba(255,199,44,0.85)", // #FFC72C
        hoverBackgroundColor: "rgba(255,199,44,1)",

        borderColor: "rgba(11,15,20,0.28)",
        borderWidth: 1,

        borderRadius: 12,
        barThickness: 16,
        maxBarThickness: 20,
        categoryPercentage: 0.78,
        barPercentage: 0.9
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: "y", // ✅ horizontal bars fix long labels

      layout: { padding: { left: 8, right: 12, top: 6, bottom: 6 } },

      plugins: {
        legend: { display: false },

        tooltip: {
          backgroundColor: "rgba(255,255,255,0.98)",
          titleColor: "#0b0f14",
          bodyColor: "#111827",
          borderColor: "rgba(0,0,0,0.10)",
          borderWidth: 1,
          cornerRadius: 12,
          padding: 12,
          displayColors: false,
          callbacks: {
            // Show full, unshortened label from original array
            title: (items) => {
              const i = items?.[0]?.dataIndex ?? 0;
              return sortedLabels[i] || "Skill";
            },
            label: (ctx) => {
              const v = ctx.parsed.x ?? 0;
              const pct = v / total;
              return ` ${v.toLocaleString()} mentions • ${(pct*100).toFixed(1)}% of skill mentions`;
            }
          }
        }
      },

      scales: {
        x: {
          beginAtZero: true,
          grid: {
            color: "rgba(17,24,39,0.08)",
            drawBorder: false
          },
          ticks: {
            color: "rgba(17,24,39,0.78)",
            font: { weight: "800" },
            precision: 0,
            callback: (v)=> Number(v).toLocaleString()
          }
        },
        y: {
          grid: { display: false, drawBorder: false },
          ticks: {
            color: "rgba(11,15,20,0.92)",   // ✅ darker = readable
            font: { weight: "900" },
            padding: 6
          }
        }
      },

      animation: { duration: 550, easing: "easeOutQuart" }
    }
  });
}

function renderRoleFamiliesChart(labels, values){
  const ctx = $("#roleFamiliesChart");
  if(roleFamiliesChart) roleFamiliesChart.destroy();

  roleFamiliesChart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label:"Postings", data: values, borderWidth: 1, borderRadius: 14 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { precision: 0, color: "rgba(238,242,255,.72)" }, grid: { color:"rgba(255,255,255,.06)" } },
        x: { ticks: { color: "rgba(238,242,255,.80)", font: { weight: "850" }, maxRotation: 25, minRotation: 25 }, grid: { display:false } }
      }
    }
  });
}

/*** BUILD DATASET ***/
function mergeStates(region){
  const byState = region?.byState || {};
  const OH = byState.OH;
  const KY = byState.KY;

  // We store full preFilter and aiSubset arrays for recomputation
  // (kept private within dashboard object; not shown unless Methods drawer)
  const merge = (a, b) => dedupeJobs([...(a||[]), ...(b||[])]);

  return {
    OH: OH,
    KY: KY,
    BOTH: {
      stateName: "OH+KY",
      preFilterTotalDeduped: (OH?.preFilterTotalDeduped||0) + (KY?.preFilterTotalDeduped||0),
      aiSubsetDeduped: (OH?.aiSubsetDeduped||0) + (KY?.aiSubsetDeduped||0),
      _preFilterJobs: merge(OH?._preFilterJobs, KY?._preFilterJobs),
      _aiJobs: merge(OH?._aiJobs, KY?._aiJobs),
      sources: { merged: true }
    }
  };
}

function applyAudienceLens(jobs, aud){
  const fn = AUDIENCE_FILTERS[aud] || AUDIENCE_FILTERS.all;
  return jobs.filter(fn);
}

/*** FETCH OH/KY (5 pages each source) ***/
async function fetchRegionOHKY(){
  const states = [
    { key:"OH", name:"Ohio" },
    { key:"KY", name:"Kentucky" }
  ];

  const result = { byState:{} };

  for(const st of states){
    const adz = await fetchPages(
      REGION_PAGES,
      ADZUNA_PER_PAGE,
      (perPage, page)=>fetchAdzunaRegion(st.name, perPage, page),
      normalizeAdzuna
    );

    const usa = await fetchPages(
      REGION_PAGES,
      USAJOBS_PER_PAGE,
      (perPage, page)=>fetchUSAJOBSRegion(st.name, perPage, page),
      normalizeUSAJOBS
    );

    const preFilter = dedupeJobs([...adz.jobs, ...usa.jobs]); // regional sample (deduped)
    const aiSubset = preFilter.filter(aiSignalMatch);

    // store arrays for lens recomputation
    result.byState[st.key] = {
      stateName: st.name,
      sources: {
        adzuna: { deduped: adz.jobs.length, raw: adz.rawCount, debug: adz.debug },
        usajobs: { deduped: usa.jobs.length, raw: usa.rawCount, debug: usa.debug }
      },
      preFilterTotalDeduped: preFilter.length,
      aiSubsetDeduped: aiSubset.length,
      _preFilterJobs: preFilter,
      _aiJobs: aiSubset
    };
  }

  return result;
}

async function loadDashboard(){
  const cached = readCache();
  if(cached) return cached;

  const region = await fetchRegionOHKY();

  // build merged structure
  const merged = mergeStates(region);

  const out = {
    fetchedAt: new Date().toISOString(),
    region, // raw byState with arrays
    merged  // convenience aggregator
  };

  writeCache(out);
  return out;
}

/*** RENDER HELPERS ***/
function renderList(rootSel, pairs, subFn){
  const root = $(rootSel);
  if(!root) return;

  if(!pairs?.length){
    root.innerHTML = `<li class="li"><div>No results yet<small>Try a different lens or state.</small></div><span>—</span></li>`;
    return;
  }

  root.innerHTML = pairs.map(([label, value]) => `
    <li class="li">
      <div>${escapeHtml(label)}${subFn ? `<small>${escapeHtml(subFn(label, value) || "")}</small>` : ""}</div>
      <span>${escapeHtml(String(value))}</span>
    </li>
  `).join("");
}

function percent(a, b){
  const v = b ? (a / b) : 0;
  return (v*100).toFixed(1) + "%";
}

function dateCoverage(jobs){
  if(!jobs?.length) return 0;
  const withDate = jobs.filter(j => !!j.date && !Number.isNaN(new Date(j.date).getTime())).length;
  return withDate / jobs.length;
}

function buildRoleFamilyCounts(aiJobs){
  const m = new Map();
  for(const j of aiJobs){
    const cat = normalizeCategoryName(roleFamily(j));
    m.set(cat, (m.get(cat)||0)+1);
  }
  const entries = [...m.entries()].sort((a,b)=>b[1]-a[1]);
  // compress tail for readability
  const top = entries.slice(0,8);
  const rest = entries.slice(8).reduce((s,[,v])=>s+v,0);
  if(rest>0) top.push(["All others", rest]);
  return top;
}

/*** RECOMMENDATIONS (simple + useful) ***/
function setRec(i, title, body){
  setText(`#rec${i}Title`, title);
  setText(`#rec${i}Body`, body);
}

/*** DRAWER ***/
function openDrawer(title, sub, html){
  $("#drawerTitle").textContent = title;
  $("#drawerSub").textContent = sub;
  $("#drawerBody").innerHTML = html;
  $("#drawer").classList.add("open");
}
function closeDrawer(){ $("#drawer").classList.remove("open"); }

/*** MAIN RENDER PIPELINE ***/
function computeView(){
  const merged = dashboard.merged;
  const stateObj = merged[currentState] || merged.BOTH;

  // base regional sample (pre-filter)
  const pre = stateObj._preFilterJobs || [];
  const ai = stateObj._aiJobs || [];

  // lens refine
  const preL = applyAudienceLens(pre, currentAudience);
  const aiL  = applyAudienceLens(ai, currentAudience);

  // KPIs
  const totalPre = preL.length;
  const totalAi  = aiL.length;
  const share = percent(totalAi, totalPre);
  const dc = dateCoverage(aiL);

  // top skills
  const sc = topNFromMap(skillCounts(aiL), 10);

  // rising skills
  const momentum = risingSkills(aiL);

  // employers
  const emps = topNFromMap(companyCounts(aiL), 10);

  // role families
  const rf = buildRoleFamilyCounts(aiL);

  return { stateObj, preL, aiL, totalPre, totalAi, share, dc, sc, momentum, emps, rf };
}

function render(){
  if(!dashboard) return;

  const v = computeView();

  // status + refresh
  setText("#status", "live");
  setText("#lastRefresh", new Date(dashboard.fetchedAt).toLocaleString());

  // KPI strip
  setText("#kRegionalTotal", fmt(v.totalPre));
  setText("#kAiTotal", fmt(v.totalAi));
  setText("#kAiShare", v.share);
  setText("#kDateCoverage", (v.dc*100).toFixed(0) + "%");

  // Top skills chart
  const labels = v.sc.map(x=>x[0]);
  const values = v.sc.map(x=>x[1]);
  renderSkillsChart(labels, values);

  // Rising list
  const m = v.momentum;
  const dcLabel = v.dc >= 0.55 ? "good" : (v.dc >= 0.35 ? "warn" : "warn");
  $("#kDateTag").className = "tag " + (v.dc >= 0.55 ? "good" : "warn");

  const note = (m.datedCount >= 30 && m.recentCount >= 10) ?
    `Based on ${m.datedCount} dated AI postings (recent: ${m.recentCount}, earlier: ${m.earlierCount}).` :
    `Limited date signal: only ${m.datedCount} dated AI postings in this view.`;

  setText("#momentumNote", note);

  const risingPairs = m.rows.map(r=>{
    const deltaPts = (r.delta * 100);
    const sign = deltaPts >= 0 ? "+" : "";
    const label = r.skill;
    const sub = `Recent: ${r.rMentions} mentions · Earlier: ${r.eMentions} mentions`;
    return [label, `${sign}${deltaPts.toFixed(1)} pts`, sub];
  });

  const root = $("#risingSkillsList");
  if(!risingPairs.length){
    root.innerHTML = `<li class="li"><div>No momentum signal yet<small>Not enough dated postings in this view.</small></div><span>—</span></li>`;
  } else {
    root.innerHTML = risingPairs.map(([label, val, sub])=>`
      <li class="li">
        <div>${escapeHtml(label)}<small>${escapeHtml(sub)}</small></div>
        <span>${escapeHtml(val)}</span>
      </li>
    `).join("");
  }

  // Employers list
  renderList("#topEmployersList", v.emps, (label, value)=>"AI-signal postings in current view");

  // Role families chart
  const rfLabels = v.rf.map(x=>x[0]);
  const rfValues = v.rf.map(x=>x[1]);
  renderRoleFamiliesChart(rfLabels, rfValues);

  // Recommendations (auto)
  const topSkill = v.sc[0]?.[0] || "AI foundations";
  const topEmp = v.emps[0]?.[0] || "top regional employers";
  const topFam = v.rf[0]?.[0] || "top role families";

  setRec(1,
    `Prioritize "${topSkill}" across core coursework`,
    `Make it a required outcome (rubric + assignments). Use labs/projects that force students to demonstrate it (not just mention it).`
  );
  setRec(2,
    `Create a 4–6 week micro-credential aligned to the top 5 skills`,
    `Bundle: tools + prompting/workflows + data foundations + governance (ethics/privacy/security) so every major can apply AI safely.`
  );
  setRec(3,
    `Outreach targets: start with ${topEmp}`,
    `Invite them for: project briefs, guest “day-in-the-life,” internship pathways, and advisory feedback on the skill map.`
  );
  setRec(4,
    `Embed AI skills where the jobs are: ${topFam}`,
    `Use role families to decide where AI goes in curricula: e.g., Data & Analytics modules in business analytics; AI/ML modules in computing; governance in all.`
  );
}

/*** UI EVENTS ***/
function wireUI(){
  // Drawer
  $("#drawerClose").addEventListener("click", closeDrawer);
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeDrawer(); });

  $("#forceRefresh").addEventListener("click", ()=>{ clearCache(); location.reload(); });

  // State toggle
  $$('.seg button[data-state]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      currentState = btn.dataset.state;
      $$('.seg button[data-state]').forEach(b=> b.setAttribute("aria-pressed", b.dataset.state === currentState ? "true" : "false"));
      render();
    });
  });

  // Audience toggle
  $$('.seg button[data-aud]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      currentAudience = btn.dataset.aud;
      $$('.seg button[data-aud]').forEach(b=> b.setAttribute("aria-pressed", b.dataset.aud === currentAudience ? "true" : "false"));
      render();
    });
  });

  // Drawer content
  $("#openMethods").addEventListener("click", ()=>{
    const sub = `Worker: ${PROXY_BASE} · Regional fetch: ${REGION_PAGES} pages/state/source · Per-page: Adzuna ${ADZUNA_PER_PAGE}, USAJOBS ${USAJOBS_PER_PAGE}`;
    openDrawer(
      "Methods & Sources",
      sub,
      `
        <div class="section">
          <p><strong>Goal:</strong> Focus on curriculum decisions (skills) and outreach decisions (employers) for Ohio + Kentucky.</p>
          <ul>
            <li><strong>Step 1 — Regional sample (pre-filter):</strong> Fetch ${REGION_PAGES} pages each from <code>Adzuna</code> and <code>USAJOBS</code> for Ohio and Kentucky, then dedupe.</li>
            <li><strong>Step 2 — AI-signal subset:</strong> Filter the regional sample using transparent AI terms.</li>
            <li><strong>Step 3 — Skills + Employers:</strong> Count skill phrase mentions and employer frequencies inside the AI-signal subset.</li>
            <li><strong>Step 4 — Rising Skills:</strong> Compare recent (last 30 days) vs earlier postings (30–120 days) when dates are available.</li>
          </ul>
          <p><strong>Sources used:</strong> Adzuna (private-sector job ads), USAJOBS (federal jobs). This blend gives a more balanced picture than a single source.</p>
        </div>

        <div class="section">
          <p><strong>AI filter terms (editable):</strong></p>
          <pre>${escapeHtml(JSON.stringify(AI_TERMS, null, 2))}</pre>
        </div>

        <div class="section">
          <p><strong>Skill map (editable):</strong></p>
          <pre>${escapeHtml(JSON.stringify(SKILLS, null, 2))}</pre>
        </div>

        <div class="section">
          <p><strong>How to increase sample size:</strong></p>
          <ul>
            <li>Increase <code>REGION_PAGES</code> (e.g., 8–10) and/or <code>ADZUNA_PER_PAGE</code>, <code>USAJOBS_PER_PAGE</code> (e.g., 75–100).</li>
            <li>Watch for rate limits; if you hit <code>429</code>, reduce pages or add delays between page requests.</li>
          </ul>
        </div>
      `
    );
  });

  $("#openInterpret").addEventListener("click", ()=>{
    openDrawer(
      "How to interpret these KPIs",
      "This dashboard only shows KPIs that directly help NKU make teaching + partnership decisions.",
      `
        <div class="section">
          <p><strong>Regional sample size (pre-filter):</strong> how many postings we pulled before applying any AI filter. Bigger sample → more stable signals.</p>
          <p><strong>AI-signal postings (subset):</strong> postings that mention AI signals. This is the subset used for Top Skills, Rising Skills, Employers, and Role Families.</p>
          <p><strong>AI-signal share:</strong> directional indicator for how often AI expectations show up in regional postings.</p>
          <p><strong>Date coverage:</strong> impacts the reliability of “Rising Skills.” If date coverage is low, treat momentum as limited.</p>
        </div>
      `
    );
  });

  $("#openSkillMap").addEventListener("click", ()=>{
    openDrawer(
      "Skill map (what counts as a “skill signal”)",
      "This is intentionally transparent so NKU can audit and tune it with chairs and partners.",
      `
        <div class="section">
          <p>This dashboard uses a phrase-based map to detect skill signals inside job titles/descriptions. You can add/remove keys to align with NKU outcomes and accreditation language.</p>
          <pre>${escapeHtml(JSON.stringify(SKILLS, null, 2))}</pre>
        </div>
      `
    );
  });

  $("#openMomentum").addEventListener("click", ()=>{
    openDrawer(
      "Rising Skills (momentum logic)",
      "Momentum is computed only when postings include usable dates.",
      `
        <div class="section">
          <p><strong>Recent window:</strong> last 30 days</p>
          <p><strong>Earlier window:</strong> 30–120 days</p>
          <p><strong>Delta:</strong> (recent mentions per posting) − (earlier mentions per posting)</p>
          <p>Why normalize? It prevents “more postings” from automatically looking like “more momentum.”</p>
        </div>
      `
    );
  });

  $("#openEmployerNotes").addEventListener("click", ()=>{
    openDrawer(
      "Employer outreach playbook (fast)",
      "Use the Top Employers list to create a tight, high-yield outreach plan.",
      `
        <div class="section">
          <ul>
            <li><strong>Step 1:</strong> Invite top 5 employers to a 30-minute “skills validation” roundtable.</li>
            <li><strong>Step 2:</strong> Ask for 2–3 real project briefs each (analytics + automation + responsible AI).</li>
            <li><strong>Step 3:</strong> Convert briefs into student projects/capstones (with clear rubrics tied to the Top Skills).</li>
            <li><strong>Step 4:</strong> Offer internship pathways and a simple hiring signal: “students complete these 4 skill artifacts.”</li>
          </ul>
        </div>
      `
    );
  });

  $("#openRoleNotes").addEventListener("click", ()=>{
    openDrawer(
      "Role families (category logic)",
      "This simplifies the conversation for deans/chairs: where AI is showing up, by role type.",
      `
        <div class="section">
          <p>Role families are assigned using a keyword heuristic across title/category/description. They are meant to be stable, not perfect.</p>
          <ul>
            <li><strong>Use case:</strong> decide where to embed AI skills (core vs elective vs certificate).</li>
            <li><strong>Example:</strong> If Data & Analytics dominates, prioritize SQL/BI + workflow automation + governance in multiple programs.</li>
          </ul>
        </div>
      `
    );
  });

  $("#openActionsWhy").addEventListener("click", ()=>{
    openDrawer(
      "Why these actions are shown",
      "They’re derived from the current top signals in your chosen state + lens.",
      `
        <div class="section">
          <p>The action cards are simple templates built from:</p>
          <ul>
            <li><strong>Top skills:</strong> what to teach</li>
            <li><strong>Rising skills:</strong> what’s accelerating</li>
            <li><strong>Top employers:</strong> who to partner with</li>
            <li><strong>Role families:</strong> where to place skills in curricula</li>
          </ul>
        </div>
      `
    );
  });
}

/*** BOOT ***/
async function init(){
  wireUI();

  try{
    setText("#status", "loading…");
    dashboard = await loadDashboard();

    // Mark status as live if either state has any data at all
    const oh = dashboard.region?.byState?.OH;
    const ky = dashboard.region?.byState?.KY;
    const hasAny = (oh?._preFilterJobs?.length || 0) + (ky?._preFilterJobs?.length || 0) > 0;
    setText("#status", hasAny ? "live" : "limited");

    // Build merged convenience + keep arrays on merged nodes
    // (mergeStates already did it, but ensure BOTH keeps arrays even if one state is empty)
    dashboard.merged = mergeStates(dashboard.region);

    render();
  }catch(err){
    console.error(err);
    setText("#status", "error");

    openDrawer(
      "Data fetch error",
      "If this is happening for testers but not for you, it’s usually Worker env vars, rate limits, or mixed content/CORS.",
      `
        <div class="section">
          <p><strong>What to check:</strong></p>
          <ul>
            <li>Open your Worker root to confirm it responds: <code>${escapeHtml(PROXY_BASE)}</code></li>
            <li>If Adzuna returns <code>429</code>, lower pages/per-page or add request delays.</li>
            <li>Confirm your Worker is deployed to the same URL your dashboard uses.</li>
          </ul>
          <pre>${escapeHtml(String(err))}</pre>
        </div>
      `
    );
  }
}

init();
</script>
</body>
</html>
