<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Skills Demand Live Dashboard — NKU Opportunity for AI Literacy</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* NKU-ish palette (clean, bright, exec) */
      --bg:#ffffff;
      --surface:#ffffff;
      --text:#0b1220;
      --muted:#475569;
      --muted2:#64748b;

      --nkuGold:#FFC72C;
      --nkuBlack:#000000;

      --border:#e6edf7;
      --shadow: 0 10px 26px rgba(2, 8, 23, 0.08);

      --accent:#0b1220;
      --accent2:#1f2937;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --radius:16px;
      --radius2:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color:var(--text);
      line-height:1.45;
    }

    .wrap{ max-width: 1240px; margin:0 auto; padding: 18px 18px 44px; }

    header{
      position: sticky;
      top:0;
      z-index: 10;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:18px;
      padding: 16px 0;
    }

    h1{
      margin: 10px 0 6px;
      font-size: 30px;
      letter-spacing: -0.02em;
      line-height:1.15;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 13.5px;
      max-width: 980px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .02em;
      color: #0b1220;
      background: linear-gradient(180deg, #fff, #fff7da);
      border: 1px solid rgba(255,199,44,0.55);
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 8px 16px rgba(2,8,23,0.06);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--nkuGold);
      box-shadow: 0 0 0 5px rgba(255,199,44,0.25);
      display:inline-block;
    }

    .toolbar{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
      min-width: 560px;
    }

    .pillset{
      display:inline-flex;
      background: rgba(2,8,23,0.02);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
    }
    .pillset button{
      border:0;
      background: transparent;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      cursor:pointer;
      white-space:nowrap;
      transition: all .15s ease;
    }
    .pillset button[aria-pressed="true"]{
      background: linear-gradient(180deg, rgba(255,199,44,0.55), rgba(255,199,44,0.22));
      color: #0b1220;
      box-shadow: inset 0 0 0 1px rgba(2,8,23,0.08);
    }
    .pillset button:hover{ color:#0b1220; }

    .meta{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(2,8,23,0.02);
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap;
    }
    .chip strong{ color:#0b1220; }

    .status{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(2,8,23,0.02);
      font-size: 12px;
      font-weight: 950;
      color:#0b1220;
    }
    #blendStatus{
      font-weight: 950;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(2,8,23,0.10);
      background: rgba(2,8,23,0.03);
      color: var(--muted);
    }
    #blendStatus.live{ background: rgba(22,163,74,0.10); color: #0f3d1c; border-color: rgba(22,163,74,0.18); }
    #blendStatus.warn{ background: rgba(245,158,11,0.10); color: #553004; border-color: rgba(245,158,11,0.18); }
    #blendStatus.bad{ background: rgba(239,68,68,0.10); color: #5a0d0d; border-color: rgba(239,68,68,0.18); }

    .btn{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 950;
      cursor:pointer;
      color:#0b1220;
      box-shadow: 0 10px 22px rgba(2,8,23,0.06);
      transition: transform .06s ease, box-shadow .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ box-shadow: 0 14px 26px rgba(2,8,23,0.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(2,8,23,0.14);
      background: linear-gradient(180deg, rgba(255,199,44,1), rgba(255,199,44,0.78));
      color: #0b1220;
      box-shadow: 0 16px 30px rgba(255,199,44,0.25);
    }

    main{ padding-top: 12px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }
    .span-12{ grid-column: span 12; }
    .span-6{ grid-column: span 6; }
    .span-4{ grid-column: span 4; }
    .span-3{ grid-column: span 3; }

    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding: 14px 16px 10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #fff, rgba(2,8,23,0.01));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .hd h2{
      margin:0;
      font-size: 16px;
      letter-spacing: -0.01em;
    }
    .hd p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 12.5px;
      max-width: 980px;
    }
    .bd{ padding: 14px 16px 16px; }

    .headerTabs{
      display:flex;
      justify-content:flex-start;
      gap:10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .tabBtn{
      border: 1px solid var(--border);
      background: rgba(2,8,23,0.02);
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 950;
      cursor:pointer;
      color:#0b1220;
      box-shadow: 0 10px 22px rgba(2,8,23,0.06);
      transition: transform .06s ease, box-shadow .15s ease;
      white-space: nowrap;
    }
    .tabBtn.active{
      border-color: rgba(255,199,44,0.65);
      background: rgba(255,199,44,0.25);
      box-shadow: 0 14px 28px rgba(2,8,23,0.10);
    }
    .tabBtn.primary{ background: rgba(255,199,44,0.95); border-color: rgba(2,8,23,0.12); }
    .tabLink{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
    }

    .kpi{ padding: 14px 14px 12px; }
    .kpiTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .kpiLabel{
      font-size: 12px;
      font-weight: 950;
      color: var(--muted);
      letter-spacing:.01em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .hint{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(255,199,44,0.30);
      border: 1px solid rgba(2,8,23,0.08);
      color: #0b1220;
      font-size: 12px;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
    }
    .kpiValue{
      margin-top: 6px;
      font-size: 28px;
      font-weight: 980;
      letter-spacing: -0.02em;
    }
    .kpiBig{
      margin-top: 4px;
      font-size: 20px;
      font-weight: 980;
      letter-spacing: -0.02em;
      line-height: 1.15;
    }
    .kpiSub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted2);
      font-weight: 750;
    }
    .kpiTag{
      font-size: 11px;
      font-weight: 980;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(2,8,23,0.03);
      color: var(--muted);
      border: 1px solid rgba(2,8,23,0.08);
      white-space: nowrap;
    }
    .kpiTag.good{ background: rgba(22,163,74,0.10); color:#0f3d1c; border-color: rgba(22,163,74,0.18); }
    .kpiTag.warn{ background: rgba(245,158,11,0.10); color:#553004; border-color: rgba(245,158,11,0.18); }
    .kpiTag.bad{ background: rgba(239,68,68,0.10); color:#5a0d0d; border-color: rgba(239,68,68,0.18); }

    .spark{
      margin-top: 10px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,199,44,0.18), rgba(255,255,255,0));
      overflow:hidden;
    }
    .spark svg{ width:100%; height:100%; display:block; }
    .spark polyline{ stroke-linecap: round; stroke-linejoin: round; }

    .chartWrap{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      background: #fff;
    }
    .chartBoxMid{ height: 320px; padding: 12px 12px 6px; }
    .chartBoxTall{ height: 420px; padding: 12px 12px 6px; }

    .footerNote{
      margin-top: 10px;
      font-size: 12px;
      font-weight: 850;
      color: var(--muted2);
    }

    .callout{
      border: 1px solid var(--border);
      background: rgba(2,8,23,0.015);
      border-radius: 16px;
      padding: 12px 14px;
    }
    .callout .t{
      font-size: 12px;
      font-weight: 950;
      color: var(--muted);
      letter-spacing:.01em;
    }
    .callout .h{
      margin-top:6px;
      font-size: 14px;
      font-weight: 980;
      letter-spacing:-0.01em;
    }
    .callout .b{
      margin-top:6px;
      font-size: 12.5px;
      font-weight: 750;
      color: var(--muted2);
      line-height:1.5;
    }

    .emph{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(22,163,74,0.18);
      background: rgba(22,163,74,0.08);
      color:#0f3d1c;
      font-weight: 950;
      font-size: 11px;
      letter-spacing:.01em;
      white-space:nowrap;
    }

    .drawer{
      position: fixed;
      top: 14px;
      right: 14px;
      width: min(620px, calc(100vw - 28px));
      height: calc(100vh - 28px);
      background: rgba(255,255,255,0.96);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: 0 22px 60px rgba(2,8,23,0.18);
      transform: translateX(calc(100% + 18px));
      transition: transform .22s ease;
      z-index: 50;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .drawer.open{ transform: translateX(0); }

    .dh{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, #fff, rgba(2,8,23,0.02));
    }
    .dh h3{ margin:0; font-size: 16px; letter-spacing:-0.01em; }
    .muted{ color: var(--muted); }
    .close{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 950;
      cursor:pointer;
      white-space: nowrap;
    }
    .db{ padding: 12px 14px 16px; overflow:auto; }
    .section{ margin-bottom: 14px; }
    .section p{ margin: 6px 0 0; color: var(--muted); font-size: 13px; }
    .section ul{ margin: 8px 0 0 18px; color: var(--muted); font-size: 13px; }
    pre{
      margin: 10px 0 0;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(2,8,23,0.02);
      font-size: 12px;
      overflow:auto;
      color:#0b1220;
    }
    code{
      background: rgba(2,8,23,0.04);
      border: 1px solid rgba(2,8,23,0.06);
      padding: 0 6px;
      border-radius: 8px;
      font-weight: 850;
    }

    .skel{
      background: linear-gradient(90deg, rgba(2,8,23,.08), rgba(2,8,23,.03), rgba(2,8,23,.08));
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite;
      border-radius: 12px;
      display:inline-block;
    }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    @media (max-width: 1020px){
      .topbar{ flex-direction:column; align-items:stretch; }
      .toolbar{ align-items:flex-start; min-width:0; }
      h1{ font-size: 26px; }
    }
    @media (max-width: 900px){
      .span-3{ grid-column: span 6; }
      .span-6{ grid-column: span 12; }
    }
    @media (max-width: 680px){
      .span-3, .span-4, .span-6{ grid-column: span 12; }
      .chartBoxMid{ height: 360px; }
      .chartBoxTall{ height: 460px; }
    }

    @media print{
      header{ position: static; }
      .drawer{ display:none !important; }
      .tabBtn, .btn{ box-shadow:none !important; }
      body{ background:#fff; }
      .card{ box-shadow:none; }
      a[href]::after{ content:""; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="badge"><span class="dot"></span> Dashboard prepared for NKU · AI Skills Demand (Blended Live)</div>

        <h1>AI Skills Demand — A Positive Signal for NKU’s AI Literacy Priority</h1>

        <p class="subtitle">
          This dashboard translates real job-posting language into an optimistic, actionable story:
          <span class="emph">AI is becoming a workplace literacy</span> (like data, writing, or spreadsheets).
          That’s an opportunity for NKU to lead with <strong>responsible, student-centered AI Literacy</strong>—supporting employability,
          academic integrity, and cross-disciplinary readiness.
        </p>

        <div class="headerTabs" aria-label="Top actions">
          <button class="tabBtn active" id="tabOverview" type="button">Overview</button>
          <button class="tabBtn" id="tabMethods" type="button">Methods & Sources</button>
          <button class="tabBtn" id="tabPrint" type="button">Print / PDF</button>

          <a class="tabBtn primary tabLink" id="tabInf125" href="https://www.nku.edu" target="_blank" rel="noopener">
            INF 125: AI Literacy
          </a>
        </div>
      </div>

      <div class="toolbar">
        <div class="pillset" id="audienceToggle" role="group" aria-label="Academic lens">
          <button type="button" data-aud="all" aria-pressed="true">All programs</button>
          <button type="button" data-aud="business" aria-pressed="false">Business</button>
          <button type="button" data-aud="informatics" aria-pressed="false">Informatics</button>
          <button type="button" data-aud="health" aria-pressed="false">Health</button>
        </div>

        <div class="meta">
          <span class="chip">Last refresh: <strong id="lastRefresh">—</strong></span>
          <span class="chip">Pages per term: <strong id="pagesUsed">5</strong></span>
          <button class="btn" id="openMethods" type="button">Data details</button>
        </div>

        <div class="status">
          <span class="pill">Blend status: <span id="blendStatus" class="live">loading…</span></span>
          <button class="btn" id="forceRefresh" type="button">Force refresh</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section class="grid" aria-label="Executive narrative">
      <div class="card span-12">
        <div class="hd">
          <div>
            <h2>Academic-ready reading guide (positive framing)</h2>
            <p>
              Use this for curriculum alignment, employer partnerships, and student readiness—without fear-based AI narratives.
              The focus is <strong>capability + integrity + career outcomes</strong>.
            </p>
          </div>
          <button class="btn" id="openReadingGuide" type="button">How to use</button>
        </div>

        <div class="bd" style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px;">
          <div class="callout">
            <div class="t">What this measures</div>
            <div class="h">Employer language signals (directional)</div>
            <div class="b">
              We scan posting titles + descriptions for transparent AI keywords and skill phrases. Results are directional signals
              that help prioritize curriculum and partnerships.
            </div>
          </div>
          <div class="callout">
            <div class="t">Why it’s a positive university story</div>
            <div class="h">AI Literacy reduces risk</div>
            <div class="b">
              When students learn responsible use (verification, disclosure, ethics, privacy), it strengthens academic integrity and prepares
              graduates to use AI thoughtfully in the workplace.
            </div>
          </div>
          <div class="callout">
            <div class="t">How NKU can act quickly</div>
            <div class="h">Baseline + embedded practice</div>
            <div class="b">
              Use Top Skills + Category Mix to prioritize modules, micro-credentials, and applied projects. Use KY/OH signals to target employer outreach
              and internship pipelines.
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="grid" style="margin-top:14px" aria-label="Leadership KPIs">
      <div class="card kpi span-3">
        <div class="kpiTop">
          <div class="kpiLabel">AI-signal share <span class="hint" data-hint="aiShare">?</span></div>
          <div class="kpiTag good" id="kAiShareDelta">▲ — pts</div>
        </div>
        <div class="kpiValue" id="kAiShare">—</div>
        <div class="kpiSub">AI postings ÷ (AI + baseline) within selected lens</div>
        <div class="spark" aria-hidden="true"><svg viewBox="0 0 120 44" preserveAspectRatio="none"><polyline id="sparkAiShare" fill="none" stroke="rgba(2,8,23,.85)" stroke-width="2" points=""></polyline></svg></div>
      </div>

      <div class="card kpi span-3">
        <div class="kpiTop">
          <div class="kpiLabel">AI postings (deduped sample) <span class="hint" data-hint="sampleSize">?</span></div>
          <div class="kpiTag" id="kSourceMix">—</div>
        </div>
        <div class="kpiValue" id="kAiCount">—</div>
        <div class="kpiSub">Deduped across blended sources (stronger evidence)</div>
        <div class="spark" aria-hidden="true"><svg viewBox="0 0 120 44" preserveAspectRatio="none"><polyline id="sparkAiCount" fill="none" stroke="rgba(2,8,23,.85)" stroke-width="2" points=""></polyline></svg></div>
      </div>

      <div class="card kpi span-3">
        <div class="kpiTop">
          <div class="kpiLabel">Total returned (raw, pre-filter) <span class="hint" data-hint="totalScanned">?</span></div>
          <div class="kpiTag" id="kTotalTag">—</div>
        </div>
        <div class="kpiValue" id="kTotalScanned">—</div>
        <div class="kpiSub">Total postings fetched across sources before dedupe/lens KPIs</div>
        <div class="spark" aria-hidden="true"><svg viewBox="0 0 120 44" preserveAspectRatio="none"><polyline id="sparkTotal" fill="none" stroke="rgba(2,8,23,.85)" stroke-width="2" points=""></polyline></svg></div>
      </div>

      <div class="card kpi span-3">
        <div class="kpiTop">
          <div class="kpiLabel">Data quality <span class="hint" data-hint="quality">?</span></div>
          <div class="kpiTag good" id="kQualityTag">high</div>
        </div>
        <div class="kpiBig" id="kQuality">—</div>
        <div class="kpiSub">Combines date coverage + private source success + dedup strength</div>
        <div class="spark" aria-hidden="true"><svg viewBox="0 0 120 44" preserveAspectRatio="none"><polyline id="sparkQuality" fill="none" stroke="rgba(2,8,23,.85)" stroke-width="2" points=""></polyline></svg></div>
      </div>
    </section>

    <section class="grid" style="margin-top:14px" aria-label="Charts">
      <div class="card span-6">
        <div class="hd">
          <div>
            <h2>Trend over time (last 12 months)</h2>
            <p>
              Monthly counts of AI-matched postings (within the selected lens). Use for “is demand rising?” and for timing employer outreach.
            </p>
          </div>
          <button class="btn" id="openTrendNotes" type="button">Trend notes</button>
        </div>
        <div class="bd">
          <div class="chartWrap"><div class="chartBoxMid"><canvas id="trendChart"></canvas></div></div>
          <div class="footerNote">Trend uses postings with usable dates; missing dates reduce trend precision.</div>
        </div>
      </div>

      <div class="card span-6">
        <div class="hd">
          <div>
            <h2>Top AI skill signals (teachable + measurable)</h2>
            <p>
              Skill phrase mentions found in posting titles/descriptions—ideal for module priorities, micro-credentials, and applied project requirements.
              This supports a practical, responsible AI Literacy baseline.
            </p>
          </div>
          <button class="btn" id="openSkillNotes" type="button">Skill map</button>
        </div>
        <div class="bd">
          <div class="chartWrap"><div class="chartBoxMid"><canvas id="skillsChart"></canvas></div></div>
          <div class="footerNote">Skills are measured as mentions (not endorsements). The skill map is transparent and NKU-editable.</div>
        </div>
      </div>
    </section>

    <section class="grid" style="margin-top:14px" aria-label="Kentucky and Ohio focus">
      <div class="card span-6">
        <div class="hd">
          <div>
            <h2>Top KY/OH employers posting for AI skills</h2>
            <p>
              Employer names from AI-matched postings with KY/OH signals—useful for partnership targeting, internships, and advisory board outreach.
            </p>
          </div>
          <button class="btn" id="openKYOHNotes" type="button">About KY/OH</button>
        </div>
        <div class="bd">
          <div class="chartWrap"><div class="chartBoxMid"><canvas id="employersChart"></canvas></div></div>
          <div class="footerNote">Heuristic location match (city/state tokens). Use as a directional signal for outreach prioritization.</div>
        </div>
      </div>

      <div class="card span-6">
        <div class="hd">
          <div>
            <h2>Top skills in KY/OH postings</h2>
            <p>
              Same skill map, restricted to KY/OH AI postings—strong for “regional workforce alignment” conversations and co-designed curriculum.
            </p>
          </div>
          <button class="btn" id="openKYOHNotes2" type="button">About KY/OH</button>
        </div>
        <div class="bd">
          <div class="chartWrap"><div class="chartBoxMid"><canvas id="skillsKYOHChart"></canvas></div></div>
          <div class="footerNote">Shows which AI skills are appearing most in postings relevant to Kentucky and Ohio.</div>
        </div>
      </div>
    </section>

    <section class="grid" style="margin-top:14px" aria-label="Where the jobs are">
      <div class="card span-12">
        <div class="hd">
          <div>
            <h2>Where the Jobs Are (executive taxonomy)</h2>
            <p>
              Category distribution for AI-matched postings using a stable NKU-friendly mapping. This helps reinforce:
              <strong>AI literacy is cross-disciplinary</strong>—not just a computing topic.
            </p>
          </div>
          <button class="btn" id="openJobCats" type="button">Job categories</button>
        </div>
        <div class="bd">
          <div class="chartWrap"><div class="chartBoxTall"><canvas id="whereJobsChart"></canvas></div></div>
          <div class="footerNote">Uses all blended AI postings in the lens, mapped into a stable executive taxonomy.</div>
        </div>
      </div>
    </section>

  </div>
</main>

<aside class="drawer" id="drawer" role="dialog" aria-modal="false" aria-label="Drawer">
  <div class="dh">
    <div>
      <h3 id="drawerTitle">Details</h3>
      <div class="muted" style="font-size:12px" id="drawerSubtitle">—</div>
    </div>
    <button class="close" type="button" id="drawerClose">Close</button>
  </div>
  <div class="db" id="drawerBody"></div>
</aside>

<script>
/*****************************************************************
 * CONFIG (CLOUDFLARE WORKER ONLY — NO VERCEL)
 *****************************************************************/
const PROXY_BASE = "https://ai-skills-proxy.nealb3.workers.dev";

/* sample-size controls */
const PAGES_PER_TERM = 5;
const RESULTS_PER_PAGE = 25;

/* LinkedIn pull via Worker: /linkedin (0-based paging) */
const LINKEDIN_PAGES_PER_TERM = 2;       // keep lower (scrape risk / rate limits)
const LINKEDIN_RESULTS_PER_PAGE = 25;    // keep <= 25
const LINKEDIN_DEFAULT_LOCATION = "United States"; // ✅ changed from hard-coded Kentucky

const CACHE_KEY = "nku_exec_ai_dashboard_v10_worker_linkedin";
const CACHE_TTL_MS = 60 * 60 * 1000; // 1 hour

const AI_TERMS_US = [
  "artificial intelligence","machine learning","generative ai","genai","llm",
  "large language model","chatgpt","copilot"
];
const AI_TERMS_ADZUNA = [
  "artificial intelligence","machine learning","llm","generative ai","genai","copilot"
];
const AI_TERMS_LINKEDIN = [
  "artificial intelligence","machine learning","generative ai","genai","llm","copilot"
];

/* baseline comparison group (pre-AI filter pool) */
const BASELINE_TERMS = ["software","analyst","manager"];
const BASELINE_LINKEDIN = ["software engineer","business analyst","project manager"];

/* NKU-friendly academic lenses (explainable filters) */
const AUDIENCE_FILTERS = {
  all: () => true,
  business: (job) => /(analyst|finance|account|marketing|operations|product|strategy|business|supply|procurement|risk|audit)/i
    .test(asText(job.title) + " " + asText(job.description)),
  informatics: (job) => /(engineer|developer|software|data scientist|ml|ai|cloud|devops|security|cyber|architect|platform|systems|network)/i
    .test(asText(job.title) + " " + asText(job.description)),
  health: (job) => /(health|clinical|patient|hospital|medical|biostat|epidemi|informatics|care|nursing|pharma|imaging)/i
    .test(asText(job.title) + " " + asText(job.description)),
};

/* Skill map (transparent, NKU-editable) */
const SKILLS = [
  { skill:"AI tools (Copilot/ChatGPT)", keys:["copilot","chatgpt","assistant"] },
  { skill:"Prompting & workflow design", keys:["prompt","prompting","agent","agentic","workflow","orchestration"] },
  { skill:"LLM apps (RAG + vector)", keys:["rag","retrieval","vector","embedding","langchain","prompt engineering"] },
  { skill:"Responsible AI / ethics", keys:["responsible ai","ethics","fairness","bias","governance","policy","compliance"] },
  { skill:"AI evaluation & testing", keys:["evaluation","testing","red team","red-team","benchmark","validation","monitoring","model risk"] },
  { skill:"Privacy", keys:["privacy","pii","phi","gdpr","hipaa","data protection"] },
  { skill:"Security", keys:["security","secure","infosec","soc","zero trust","iam","identity","access","vulnerability","threat"] },
  { skill:"SQL / BI dashboards", keys:["sql","power bi","tableau","dashboard","analytics","reporting"] },
  { skill:"Data engineering", keys:["data engineer","pipeline","warehouse","lakehouse","spark","dbt"] },
  { skill:"Python", keys:["python","scripting","etl"] },
  { skill:"Cloud platforms", keys:["aws","azure","gcp","cloud","kubernetes","docker"] },
  { skill:"Process improvement / automation", keys:["process improvement","automation","workflow","rpa","lean","six sigma","kaizen"] },
];

/*****************************************************************
 * DOM UTILS
 *****************************************************************/
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function setText(sel, txt){ const el = $(sel); if(el) el.textContent = txt; }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function asText(v){
  if(v == null) return "";
  if(Array.isArray(v)) return v.filter(Boolean).join(" ");
  if(typeof v === "string") return v;
  if(typeof v === "number" || typeof v === "boolean") return String(v);
  try { return JSON.stringify(v); } catch { return String(v); }
}
function pct(x){ return (x*100).toFixed(1) + "%"; }
function animatePercent(el, targetPctText){
  if(!el) return;
  const m = String(targetPctText).match(/^(\d+(\.\d+)?)%$/);
  if(!m){ el.textContent = targetPctText; return; }
  const target = parseFloat(m[1]);
  const start = 0;
  const t0 = performance.now();
  const dur = 650;
  function tick(t){
    const p = Math.min(1, (t - t0)/dur);
    const v = (start + (target-start)*p);
    el.textContent = v.toFixed(1) + "%";
    if(p < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}
function sparkPoints(values){
  if(!values || values.length < 2) return "";
  const max = Math.max(...values), min = Math.min(...values);
  const range = (max - min) || 1;
  return values.map((v,i)=>{
    const x = (i/(values.length-1))*120;
    const y = 42 - ((v-min)/range)*36;
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(" ");
}
function tagForDelta(deltaPts){
  if(deltaPts > 1.5) return { cls: "good" };
  if(deltaPts < -1.5) return { cls: "warn" };
  return { cls: "good" };
}

/*****************************************************************
 * CACHE
 *****************************************************************/
function readCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(Date.now() - obj.time > CACHE_TTL_MS) return null;
    return obj.data;
  }catch{ return null; }
}
function writeCache(data){
  try{ localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), data })); }catch{}
}
function clearCache(){
  try{ localStorage.removeItem(CACHE_KEY); }catch{}
}

/*****************************************************************
 * FETCHERS (via Worker)
 *****************************************************************/
async function fetchJson(url){
  const res = await fetch(url, { cache:"no-store" });
  const text = await res.text();
  let json;
  try{ json = JSON.parse(text); }catch{
    throw new Error("Non-JSON from " + url + ": " + text.slice(0,200));
  }
  if(!res.ok){
    const msg = json?.error || json?.message || ("HTTP " + res.status);
    throw new Error(url + " → " + msg);
  }
  return json;
}

async function fetchUSAJOBS(term, perPage=25, page=1){
  const t = encodeURIComponent(term);
  const url = `${PROXY_BASE}/usajobs?keyword=${t}&ResultsPerPage=${perPage}&Page=${page}`;
  return { url, json: await fetchJson(url), term, page };
}
async function fetchAdzuna(term, perPage=25, page=1){
  const t = encodeURIComponent(term);
  const url = `${PROXY_BASE}/adzuna?what=${t}&results_per_page=${perPage}&page=${page}&country=us`;
  return { url, json: await fetchJson(url), term, page };
}
async function fetchRemotive(searchTerm=""){
  const q = encodeURIComponent(searchTerm || "");
  const url = `${PROXY_BASE}/remotive${q ? `?search=${q}` : ""}`;
  return { url, json: await fetchJson(url), term: searchTerm, page: 1 };
}

/* ✅ LinkedIn via Worker: /linkedin (0-based paging) */
async function fetchLinkedIn(term, perPage=25, page0=0){
  const t = encodeURIComponent(term);
  const loc = encodeURIComponent(LINKEDIN_DEFAULT_LOCATION); // ✅ changed
  const url =
    `${PROXY_BASE}/linkedin?keyword=${t}` +
    `&location=${loc}` +
    `&dateSincePosted=${encodeURIComponent("past week")}` +
    `&sortBy=${encodeURIComponent("recent")}` +
    `&page=${encodeURIComponent(String(page0))}` +
    `&limit=${encodeURIComponent(String(perPage))}`;

  return { url, json: await fetchJson(url), term, page: page0 };
}

/*****************************************************************
 * NORMALIZERS
 *****************************************************************/
function parseDateSafe(x){
  if(!x) return null;
  const d = new Date(x);
  if(Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}
function normalizeUSAJOBS(payload){
  const items = payload?.SearchResult?.SearchResultItems || [];
  return items.map(it=>{
    const d = it?.MatchedObjectDescriptor || {};
    const details = d?.UserArea?.Details || {};
    const cats = (d?.JobCategory || []).map(c=>c?.Name).filter(Boolean);
    const dateRaw = d?.PublicationStartDate || d?.PositionStartDate || d?.ApplicationCloseDate || null;

    const duties = asText(details?.MajorDuties);
    const summary = asText(details?.JobSummary);
    const desc = duties || summary;

    return {
      source: "USAJOBS",
      title: asText(d?.PositionTitle),
      description: desc,
      company: asText(d?.OrganizationName || d?.DepartmentName || "Federal"),
      category: asText(cats[0] || d?.DepartmentName || "Federal"),
      location: asText((d?.PositionLocation || [])[0]?.LocationName || ""),
      url: asText(d?.PositionURI || ""),
      date: parseDateSafe(dateRaw)
    };
  });
}
function normalizeAdzuna(payload){
  const items = payload?.results || [];
  return items.map(it=>({
    source: "Adzuna",
    title: asText(it?.title),
    description: asText(it?.description),
    company: asText(it?.company?.display_name || "Unknown"),
    category: asText(it?.category?.label || "Other"),
    location: asText(it?.location?.display_name || ""),
    url: asText(it?.redirect_url || it?.adref || ""),
    date: parseDateSafe(it?.created || it?.created_at || it?.publication_date || null)
  }));
}
function normalizeRemotive(payload){
  const items = payload?.jobs || payload?.data?.jobs || [];
  return items.map(it => ({
    source: "Remotive",
    title: asText(it?.title),
    description: asText(it?.description),
    company: asText(it?.company_name || it?.company || "Unknown"),
    category: asText(it?.category || it?.job_type || "Remote"),
    location: asText(it?.candidate_required_location || "Remote"),
    url: asText(it?.url || it?.job_url || ""),
    date: parseDateSafe(it?.publication_date || it?.created_at || null)
  }));
}

/* ✅ LinkedIn normalizer: NOW reads postedAt so trend/date coverage works */
function normalizeLinkedIn(payload){
  const items = payload?.jobs || payload?.data?.jobs || payload?.results || [];
  return items.map(it => ({
    source: "LinkedIn",
    title: asText(it?.title || it?.position),
    description: asText(it?.description || ""),
    company: asText(it?.company || "Unknown"),
    category: asText(it?.category || "LinkedIn"),
    location: asText(it?.location || ""),
    url: asText(it?.url || it?.jobUrl || it?.link || ""),
    date: parseDateSafe(
      it?.postedAt ||          // ✅ your upstream returns this
      it?.date ||
      it?.listedAt ||
      it?.publishedAt ||
      it?.created_at ||
      it?.createdAt ||
      null
    )
  }));
}

/*****************************************************************
 * DEDUPE
 *****************************************************************/
function dedupeJobs(jobs){
  const seen = new Set();
  const out = [];
  for(const j of jobs){
    const key = (asText(j.url) || `${asText(j.source)}|${asText(j.company)}|${asText(j.title)}|${asText(j.location)}`)
      .toLowerCase().trim();
    if(seen.has(key)) continue;
    seen.add(key);
    out.push(j);
  }
  return out;
}

/*****************************************************************
 * FANOUT WITH PAGINATION (1-based + 0-based helpers)
 *****************************************************************/
const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

async function fanoutFetchPages(terms, fetcher, normalizer, pages=5, perPage=25){
  const all = [];
  const debug = [];

  for(const term of terms){
    for(let page=1; page<=pages; page++){
      try{
        const r = await fetcher(term, perPage, page);
        debug.push({ term, page, ok:true, url:r.url });
        all.push(...normalizer(r.json));
        await sleep(120);
      }catch(err){
        debug.push({ term, page, ok:false, error:String(err).slice(0,220) });
      }
    }
  }

  const deduped = dedupeJobs(all);
  return { jobs: deduped, rawCount: all.length, debug };
}

async function fanoutFetchPagesZeroBased(terms, fetcher, normalizer, pages=2, perPage=25){
  const all = [];
  const debug = [];

  for(const term of terms){
    for(let page0=0; page0<pages; page0++){
      try{
        const r = await fetcher(term, perPage, page0);
        debug.push({ term, page: page0, ok:true, url:r.url });
        all.push(...normalizer(r.json));
        await sleep(160);
      }catch(err){
        debug.push({ term, page: page0, ok:false, error:String(err).slice(0,220) });
      }
    }
  }

  const deduped = dedupeJobs(all);
  return { jobs: deduped, rawCount: all.length, debug };
}

/*****************************************************************
 * BLEND PIPELINE (INCLUDES LINKEDIN VIA WORKER /linkedin)
 *****************************************************************/
async function fetchBlend(){
  const cached = readCache();
  if(cached) return cached;

  const aiUS = await fanoutFetchPages(AI_TERMS_US, fetchUSAJOBS, normalizeUSAJOBS, PAGES_PER_TERM, RESULTS_PER_PAGE);
  const aiAD = await fanoutFetchPages(AI_TERMS_ADZUNA, fetchAdzuna, normalizeAdzuna, PAGES_PER_TERM, RESULTS_PER_PAGE);
  const aiRM = await fanoutFetchPages(["machine learning","generative ai","llm","copilot"], (t)=>fetchRemotive(t), normalizeRemotive, 1, 50);

  const aiLI = await fanoutFetchPagesZeroBased(
    AI_TERMS_LINKEDIN,
    fetchLinkedIn,
    normalizeLinkedIn,
    LINKEDIN_PAGES_PER_TERM,
    LINKEDIN_RESULTS_PER_PAGE
  );

  const baseUS = await fanoutFetchPages(BASELINE_TERMS, fetchUSAJOBS, normalizeUSAJOBS, PAGES_PER_TERM, RESULTS_PER_PAGE);
  const baseAD = await fanoutFetchPages(BASELINE_TERMS, fetchAdzuna, normalizeAdzuna, PAGES_PER_TERM, RESULTS_PER_PAGE);
  const baseRM = await fanoutFetchPages(["engineer","analyst","manager"], (t)=>fetchRemotive(t), normalizeRemotive, 1, 50);

  const baseLI = await fanoutFetchPagesZeroBased(
    BASELINE_LINKEDIN,
    fetchLinkedIn,
    normalizeLinkedIn,
    LINKEDIN_PAGES_PER_TERM,
    LINKEDIN_RESULTS_PER_PAGE
  );

  const aiJobs = dedupeJobs([...aiUS.jobs, ...aiAD.jobs, ...aiRM.jobs, ...aiLI.jobs]);
  const baseJobs = dedupeJobs([...baseUS.jobs, ...baseAD.jobs, ...baseRM.jobs, ...baseLI.jobs]);

  const out = {
    fetchedAt: new Date().toISOString(),
    aiJobs,
    baseJobs,
    raw: {
      aiRaw: aiUS.rawCount + aiAD.rawCount + aiRM.rawCount + aiLI.rawCount,
      baseRaw: baseUS.rawCount + baseAD.rawCount + baseRM.rawCount + baseLI.rawCount
    },
    debug: {
      aiUS: aiUS.debug, aiAD: aiAD.debug, aiRM: aiRM.debug, aiLI: aiLI.debug,
      baseUS: baseUS.debug, baseAD: baseAD.debug, baseRM: baseRM.debug, baseLI: baseLI.debug
    },
    pagesUsed: PAGES_PER_TERM,
    perPage: RESULTS_PER_PAGE,
    linkedin: { pagesUsed: LINKEDIN_PAGES_PER_TERM, perPage: LINKEDIN_RESULTS_PER_PAGE }
  };

  writeCache(out);
  return out;
}

/*****************************************************************
 * REGION / REMOTE
 *****************************************************************/
function isRemote(job){
  const loc = (asText(job.location) + " " + asText(job.category)).toLowerCase();
  return /remote|telework|work from home|wfh/.test(loc);
}
function isOH(job){
  const loc = (asText(job.location) + " " + asText(job.title)).toLowerCase();
  return /\boh\b|ohio|cincinnati|dayton|columbus|cleveland|toledo|akron/.test(loc);
}
function isKY(job){
  const loc = (asText(job.location) + " " + asText(job.title)).toLowerCase();
  return /\bky\b|kentucky|covington|newport|florence|lexington|louisville|bowling green|frankfort/.test(loc);
}
function isOHKY(job){ return isOH(job) || isKY(job); }

/*****************************************************************
 * CATEGORY MAPPING (stable exec taxonomy)
 *****************************************************************/
function textBlob(job){
  return `${asText(job.title)} ${asText(job.category)} ${asText(job.company)} ${asText(job.location)} ${asText(job.description)}`.toLowerCase();
}
function nkuExecCategory(job){
  const blob = textBlob(job);

  if (/\b(ai|artificial intelligence|machine learning|ml|llm|genai|generative ai|nlp|computer vision|rag|embedding|vector)\b/.test(blob)) {
    return "AI / ML";
  }
  if (/\b(data analyst|data analytics|analytics|bi\b|sql\b|power bi|tableau|dashboard|reporting|data warehouse|etl|dbt|spark|lakehouse|data engineer)\b/.test(blob)) {
    return "Data & Analytics";
  }
  if (/\b(devops|sre|site reliability|kubernetes|docker|ci\/cd|terraform|cloud infrastructure)\b/.test(blob)) {
    return "DevOps / Cloud";
  }
  if (/\b(software|developer|engineer|full[- ]stack|frontend|backend|mobile|web developer|api\b|typescript|javascript|java\b|c\+\+|c#|python\b|golang|rust)\b/.test(blob)) {
    return "Software Development";
  }
  if (/\b(cyber|security|infosec|soc\b|zero trust|iam\b|identity|access|vulnerability|penetration|siem|risk|compliance)\b/.test(blob)) {
    return "Cybersecurity / IT";
  }
  if (/\b(product manager|product management|project manager|program manager|scrum|agile|product owner|pm\b)\b/.test(blob)) {
    return "Product / Project";
  }
  if (/\b(business analyst|operations|strategy|process improvement|continuous improvement|lean\b|six sigma|supply chain|procurement|finance|accounting)\b/.test(blob)) {
    return "Business / Operations";
  }
  if (/\b(marketing|growth|seo\b|content|brand|demand gen|sales|account executive|customer success|support|client)\b/.test(blob)) {
    return "Marketing / Sales";
  }
  if (/\b(health|clinical|patient|hospital|medical|biostat|epidemi|informatics|care|nursing|pharma|imaging)\b/.test(blob)) {
    return "Health / Clinical";
  }
  if (/\b(instructor|trainer|curriculum|learning|education|teaching)\b/.test(blob)) {
    return "Education / Training";
  }
  return "Other";
}
function normalizeCategoryDisplay(cat){
  let c = asText(cat).trim();
  if(!c) return "Other";
  c = c.replace(/\s+/g," ").trim();
  return c;
}

/*****************************************************************
 * DATE SERIES
 *****************************************************************/
function dayKey(isoOrDate){
  const d = (isoOrDate instanceof Date) ? isoOrDate : new Date(isoOrDate);
  if(Number.isNaN(d.getTime())) return null;
  const dd = new Date(d);
  dd.setHours(0,0,0,0);
  return dd.toISOString().slice(0,10);
}
function lastNDaysKeys(n=14){
  const now = new Date();
  now.setHours(0,0,0,0);
  const keys = [];
  for(let i=n-1;i>=0;i--){
    const d = new Date(now);
    d.setDate(now.getDate()-i);
    keys.push(d.toISOString().slice(0,10));
  }
  return keys;
}
function buildDailySeries(aiJobs, baseJobs, n=14){
  const keys = lastNDaysKeys(n);

  const aiByDay = new Map(keys.map(k=>[k, []]));
  const baseByDay = new Map(keys.map(k=>[k, []]));

  for(const j of aiJobs){
    const k = j.date ? dayKey(j.date) : null;
    if(k && aiByDay.has(k)) aiByDay.get(k).push(j);
  }
  for(const j of baseJobs){
    const k = j.date ? dayKey(j.date) : null;
    if(k && baseByDay.has(k)) baseByDay.get(k).push(j);
  }

  const aiShare = [];
  const aiCount = [];
  const totalCount = [];

  for(const k of keys){
    const a = aiByDay.get(k) || [];
    const b = baseByDay.get(k) || [];
    const aN = a.length;
    const bN = b.length;

    aiCount.push(aN);
    totalCount.push(aN + bN);
    aiShare.push(aN / Math.max(aN + bN, 1));
  }

  return { aiShare, aiCount, totalCount };
}
function sumNewInLastDays(aiJobs, days=14){
  const keys = new Set(lastNDaysKeys(days));
  let n = 0;
  for(const j of aiJobs){
    const k = j.date ? dayKey(j.date) : null;
    if(k && keys.has(k)) n++;
  }
  return n;
}
function monthKey(iso){
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return null;
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function trendByMonth(jobs, months=12){
  const dated = jobs.filter(j=>!!j.date);
  const keys = dated.map(j=>monthKey(j.date)).filter(Boolean);
  if(!keys.length){
    const labels = Array.from({length: Math.min(6, months)}, (_,i)=>`M-${Math.min(6, months)-i}`);
    const values = labels.map(()=>jobs.length ? Math.max(1, Math.round(jobs.length/labels.length)) : 0);
    return { labels, values };
  }

  const max = keys.reduce((a,b)=> a>b ? a : b);
  const [Y,M] = max.split("-").map(Number);
  const counts = new Map();
  for(const k of keys) counts.set(k, (counts.get(k)||0)+1);

  const labels = [];
  for(let i=months-1;i>=0;i--){
    const dd = new Date(Date.UTC(Y, M-1 - i, 1));
    const key = `${dd.getUTCFullYear()}-${String(dd.getUTCMonth()+1).padStart(2,"0")}`;
    labels.push(key);
  }
  const values = labels.map(k => counts.get(k) || 0);
  return { labels, values };
}

/*****************************************************************
 * SKILL COUNTS
 *****************************************************************/
function skillCounts(jobs){
  const counts = new Map();
  for(const s of SKILLS) counts.set(s.skill, 0);

  for(const j of jobs){
    const text = (asText(j.title) + " " + asText(j.description)).toLowerCase();
    for(const s of SKILLS){
      if(s.keys.some(k => text.includes(String(k).toLowerCase()))) {
        counts.set(s.skill, (counts.get(s.skill)||0) + 1);
      }
    }
  }
  return counts;
}

/*****************************************************************
 * QUALITY / CONFIDENCE
 *****************************************************************/
function computeQuality(blended, aiJobsLens){
  const adOk = blended.debug?.aiAD?.some(x => x.ok);
  const rmOk = blended.debug?.aiRM?.some(x => x.ok);
  const liOk = blended.debug?.aiLI?.some(x => x.ok);
  const anyPrivateOk = !!(adOk || rmOk || liOk);

  const dateCoverage = aiJobsLens.length ? (aiJobsLens.filter(j=>!!j.date).length / aiJobsLens.length) : 0;
  const dedupRate = blended.raw?.aiRaw ? (1 - (blended.aiJobs.length / Math.max(blended.raw.aiRaw, 1))) : 0;

  let label = "Medium";
  let tag = { text: "medium", cls: "warn" };

  if(anyPrivateOk && dateCoverage >= 0.6) {
    label = "High";
    tag = { text: "high", cls: "good" };
  }
  if(!anyPrivateOk && dateCoverage < 0.4) {
    label = "Low";
    tag = { text: "low", cls: "bad" };
  }

  const series = [
    anyPrivateOk ? 1 : 0.35,
    dateCoverage,
    dedupRate
  ].map(v=>Math.max(0, Math.min(1, v)));

  return { label, tag, dateCoverage, dedupRate, anyPrivateOk, series };
}

/*****************************************************************
 * STATE
 *****************************************************************/
let blended = null;
let currentAudience = "all";

/*****************************************************************
 * CHARTS
 *****************************************************************/
let whereChart = null;
let trendChart = null;
let skillsChart = null;
let employersChart = null;
let skillsKYOHChart = null;

function renderWhereJobsChart(labels, values){
  const ctx = $("#whereJobsChart");
  if(whereChart) whereChart.destroy();

  whereChart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label:"Postings", data: values, borderWidth:1, borderRadius:10 }] },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } }, x:{ ticks:{ maxRotation:30, minRotation:30 } } }
    }
  });
}

function renderTrendChart(labels, values){
  const ctx = $("#trendChart");
  if(trendChart) trendChart.destroy();

  trendChart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label:"AI postings (monthly)", data: values, borderWidth:2, pointRadius:2, tension:0.25 }] },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=> `${c.parsed.y} postings` } } },
      scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
    }
  });
}

function renderSkillsChart(labels, values){
  const ctx = $("#skillsChart");
  if(skillsChart) skillsChart.destroy();

  skillsChart = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label:"Mentions", data: values, borderWidth:1, borderRadius:10 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      indexAxis:"y",
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=> `${c.parsed.x} mentions` } } },
      scales:{ x:{ beginAtZero:true, ticks:{ precision:0 } }, y:{ ticks:{ font:{ weight:"800" } } } }
    }
  });
}

function renderEmployersChart(labels, values){
  const ctx = $("#employersChart");
  if(employersChart) employersChart.destroy();

  employersChart = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label:"AI postings (KY/OH)", data: values, borderWidth:1, borderRadius:10 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      indexAxis:"y",
      plugins:{ legend:{ display:false } },
      scales:{ x:{ beginAtZero:true, ticks:{ precision:0 } }, y:{ ticks:{ font:{ weight:"800" } } } }
    }
  });
}

function renderSkillsKYOHChart(labels, values){
  const ctx = $("#skillsKYOHChart");
  if(skillsKYOHChart) skillsKYOHChart.destroy();

  skillsKYOHChart = new Chart(ctx, {
    type:"bar",
    data:{ labels, datasets:[{ label:"Mentions (KY/OH)", data: values, borderWidth:1, borderRadius:10 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      indexAxis:"y",
      plugins:{ legend:{ display:false } },
      scales:{ x:{ beginAtZero:true, ticks:{ precision:0 } }, y:{ ticks:{ font:{ weight:"800" } } } }
    }
  });
}

/*****************************************************************
 * LENS COMPUTATION
 *****************************************************************/
function computeLens(blended, aud){
  const audFn = AUDIENCE_FILTERS[aud] || AUDIENCE_FILTERS.all;
  const ai = blended.aiJobs.filter(audFn);
  const base = blended.baseJobs.filter(audFn);

  const aiSafe = ai.length ? ai : blended.aiJobs;
  const baseSafe = base.length ? base : blended.baseJobs;

  const share = aiSafe.length / Math.max(aiSafe.length + baseSafe.length, 1);

  const series14 = buildDailySeries(aiSafe, baseSafe, 14);
  const deltaPts = (arr) => (arr && arr.length>=2) ? (arr[arr.length-1] - arr[0]) * 100 : 0;
  const deltas = { sharePts: deltaPts(series14.aiShare) };

  const quality = computeQuality(blended, aiSafe);

  const sc = skillCounts(aiSafe);
  const skillEntries = [...sc.entries()].sort((a,b)=>b[1]-a[1]).slice(0, 10);
  const skillsTop = { labels: skillEntries.map(x=>x[0]), values: skillEntries.map(x=>x[1]) };

  const trend = trendByMonth(aiSafe, 12);

  const whereCounts = new Map();
  for(const j of aiSafe){
    const cat = normalizeCategoryDisplay(nkuExecCategory(j));
    whereCounts.set(cat, (whereCounts.get(cat)||0) + 1);
  }
  let whereEntries = [...whereCounts.entries()].sort((a,b)=>b[1]-a[1]);
  const top = whereEntries.slice(0, 8);
  const rest = whereEntries.slice(8);
  const restSum = rest.reduce((s, [,v])=>s+v, 0);
  if(restSum > 0) top.push(["All others", restSum]);
  const where = { labels: top.map(x=>x[0]), values: top.map(x=>x[1]), poolSize: aiSafe.length };

  const mixUS = aiSafe.filter(j => j.source === "USAJOBS").length;
  const mixAD = aiSafe.filter(j => j.source === "Adzuna").length;
  const mixRM = aiSafe.filter(j => j.source === "Remotive").length;
  const mixLI = aiSafe.filter(j => j.source === "LinkedIn").length;
  const mix = { mixUS, mixAD, mixRM, mixLI };

  const kyoh = aiSafe.filter(isOHKY);
  const employerCounts = new Map();
  for(const j of kyoh){
    const c = asText(j.company).trim() || "Unknown";
    employerCounts.set(c, (employerCounts.get(c)||0) + 1);
  }
  const topEmployers = [...employerCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  const kyohEmployers = { labels: topEmployers.map(x=>x[0]), values: topEmployers.map(x=>x[1]) };

  const scKYOH = skillCounts(kyoh);
  const topSkillsKYOH = [...scKYOH.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  const skillsKYOH = { labels: topSkillsKYOH.map(x=>x[0]), values: topSkillsKYOH.map(x=>x[1]) };

  // Raw total returned across sources (pre-dedupe, pre-lens)
  const totalReturnedRaw = (blended.raw?.aiRaw || 0) + (blended.raw?.baseRaw || 0);

  return {
    ai: aiSafe,
    base: baseSafe,
    share,
    series14,
    deltas,
    quality,
    skillsTop,
    trend,
    where,
    mix,
    kyohEmployers,
    skillsKYOH,
    totalReturnedRaw
  };
}

/*****************************************************************
 * RENDER
 *****************************************************************/
function renderHeaderStatus(data){
  const adOk = data.debug?.aiAD?.some(x => x.ok);
  const rmOk = data.debug?.aiRM?.some(x => x.ok);
  const liOk = data.debug?.aiLI?.some(x => x.ok);

  const statusEl = $("#blendStatus");
  if(adOk || rmOk || liOk){
    statusEl.textContent = "live (blended)";
    statusEl.className = "live";
  } else {
    statusEl.textContent = "partial (USAJOBS-only fallback)";
    statusEl.className = "warn";
  }

  setText("#lastRefresh", new Date(data.fetchedAt).toLocaleString());
  setText("#pagesUsed", String(data.pagesUsed || PAGES_PER_TERM));
}

function renderAll(){
  if(!blended) return;
  renderHeaderStatus(blended);

  const lens = computeLens(blended, currentAudience);

  animatePercent($("#kAiShare"), pct(lens.share));
  setText("#kAiCount", lens.ai.length.toLocaleString());

  // Total returned raw (pre-dedupe, pre-lens)
  setText("#kTotalScanned", lens.totalReturnedRaw.toLocaleString());
  setText("#kTotalTag", `AI raw ${ (blended.raw?.aiRaw||0).toLocaleString() } + base raw ${ (blended.raw?.baseRaw||0).toLocaleString() }`);

  const t1 = $("#kAiShareDelta");
  t1.textContent = `▲ ${lens.deltas.sharePts.toFixed(1)} pts`;
  t1.className = "kpiTag " + tagForDelta(lens.deltas.sharePts).cls;

  setText("#kSourceMix", `${lens.mix.mixUS} USAJOBS · ${lens.mix.mixAD} Adzuna · ${lens.mix.mixRM} Remotive · ${lens.mix.mixLI} LinkedIn`);

  setText("#kQuality", lens.quality.label);
  const qTag = $("#kQualityTag");
  qTag.textContent = lens.quality.tag.text;
  qTag.className = "kpiTag " + lens.quality.tag.cls;

  $("#sparkAiShare").setAttribute("points", sparkPoints(lens.series14.aiShare));
  $("#sparkAiCount").setAttribute("points", sparkPoints(lens.series14.aiCount));
  $("#sparkTotal").setAttribute("points", sparkPoints(lens.series14.totalCount));
  $("#sparkQuality").setAttribute("points", sparkPoints(lens.quality.series));

  renderSkillsChart(lens.skillsTop.labels, lens.skillsTop.values);
  renderTrendChart(lens.trend.labels, lens.trend.values);
  renderWhereJobsChart(lens.where.labels, lens.where.values);
  renderEmployersChart(lens.kyohEmployers.labels, lens.kyohEmployers.values);
  renderSkillsKYOHChart(lens.skillsKYOH.labels, lens.skillsKYOH.values);
}

/*****************************************************************
 * DRAWER
 *****************************************************************/
function openDrawer(payload){
  $("#drawerTitle").textContent = payload.title;
  $("#drawerSubtitle").textContent = payload.subtitle;
  $("#drawerBody").innerHTML = payload.html;
  $("#drawer").classList.add("open");
}
function closeDrawer(){ $("#drawer").classList.remove("open"); }

function showMethods(){
  const dbg = blended?.debug || {};
  const audLabel = ({ all:"All programs", business:"Business", informatics:"Informatics", health:"Health" }[currentAudience] || "All programs");

  const lens = blended ? computeLens(blended, currentAudience) : null;
  const dateCoverage = lens ? (lens.quality.dateCoverage*100).toFixed(1) + "%" : "—";
  const dedupRate = lens ? (lens.quality.dedupRate*100).toFixed(1) + "%" : "—";
  const privateOk = lens ? (lens.quality.anyPrivateOk ? "Yes" : "No") : "—";

  openDrawer({
    title: "Methods & Sources (Academic Detail)",
    subtitle: `Lens: ${audLabel} · Pages/term: ${PAGES_PER_TERM} · Per page: ${RESULTS_PER_PAGE} · LinkedIn pages: ${LINKEDIN_PAGES_PER_TERM}`,
    html: `
      <div class="section">
        <strong>What “blended live” means</strong>
        <ul>
          <li><strong>USAJOBS</strong> (public anchor)</li>
          <li><strong>Adzuna</strong> (private-sector breadth)</li>
          <li><strong>Remotive</strong> (remote-first breadth)</li>
          <li><strong>LinkedIn</strong> (via Cloudflare Worker route <code>/linkedin</code>)</li>
        </ul>
        <p>We dedupe across sources to reduce double-counting.</p>
      </div>

      <div class="section">
        <strong>Data quality diagnostics</strong>
        <ul>
          <li><strong>Private-sector sources available:</strong> ${escapeHtml(privateOk)}</li>
          <li><strong>Date coverage (AI lens):</strong> ${escapeHtml(dateCoverage)}</li>
          <li><strong>Dedup strength (AI):</strong> ${escapeHtml(dedupRate)}</li>
        </ul>
      </div>

      <div class="section">
        <strong>Skill map (transparent)</strong>
        <pre>${escapeHtml(JSON.stringify(SKILLS, null, 2))}</pre>
      </div>

      <div class="section">
        <strong>Debug (last fetch)</strong>
        <pre>${escapeHtml(JSON.stringify(dbg, null, 2))}</pre>
      </div>
    `
  });
}

function showReadingGuide(){
  openDrawer({
    title: "How to use this in a dean/chair/director conversation",
    subtitle: "A short, upbeat script + interpretation tips",
    html: `
      <div class="section">
        <strong>Suggested 60-second walkthrough (positive)</strong>
        <ul>
          <li><strong>AI-signal share:</strong> “AI language is becoming normal in postings—NKU can lead with responsible literacy.”</li>
          <li><strong>Sample size:</strong> “This is deduped across USAJOBS, Adzuna, Remotive, and LinkedIn for stronger evidence.”</li>
          <li><strong>Top skills:</strong> “These mentions tell us which modules students need most—prompting, verification, ethics, privacy.”</li>
          <li><strong>KY/OH focus:</strong> “These employers and skills help target regional partnerships and internships.”</li>
          <li><strong>Where the jobs are:</strong> “AI isn’t just computing—this distribution shows cross-college relevance.”</li>
        </ul>
      </div>
    `
  });
}

function showTrendNotes(){
  openDrawer({
    title: "Trend notes",
    subtitle: "How the trend chart is built (and how to interpret it)",
    html: `
      <div class="section">
        <strong>What you’re seeing</strong>
        <p>Monthly counts of AI-matched postings within the selected lens. It uses postings with usable publish dates.</p>
      </div>
    `
  });
}

function showSkillNotes(){
  openDrawer({
    title: "Skill map notes",
    subtitle: "Why this supports AI Literacy (in a positive way)",
    html: `
      <div class="section">
        <strong>Why a transparent skill map</strong>
        <p>For academic settings, transparency matters. The map is explicit and editable—use it to align with NKU outcomes and course design.</p>
      </div>
    `
  });
}

function showKYOHNotes(){
  openDrawer({
    title: "KY/OH focus notes",
    subtitle: "How we interpret Kentucky/Ohio signals",
    html: `
      <div class="section">
        <strong>What counts as KY/OH</strong>
        <p>We detect location tokens in the posting location/title (e.g., Ohio, KY, Cincinnati, Covington, Louisville, Lexington).</p>
        <p class="muted">This is a directional heuristic meant for outreach prioritization—not a perfect state-level census.</p>
      </div>
    `
  });
}

function showJobCategoriesHelp(){
  openDrawer({
    title: "Job categories",
    subtitle: "How the 'Where the Jobs Are' chart is built",
    html: `
      <div class="section">
        <strong>Executive taxonomy (stable)</strong>
        <p>We map each posting into a stable NKU-friendly taxonomy (AI/ML, Data, DevOps/Cloud, etc.).</p>
      </div>
    `
  });
}

function showHint(which){
  const hints = {
    aiShare: {
      title:"AI-signal share",
      body:`<p><strong>Definition:</strong> AI postings ÷ (AI + baseline) within the selected lens.</p>`
    },
    sampleSize: {
      title:"AI postings (sample)",
      body:`<p>This is the number of deduped AI postings in the current lens.</p>`
    },
    totalScanned: {
      title:"Total returned (raw, pre-filter)",
      body:`<p>This is the total number of postings returned by upstream APIs across sources <strong>before</strong> dedupe and lens KPIs.</p>`
    },
    quality: {
      title:"Data quality",
      body:`<p>We combine private-source success + date coverage + dedup strength into a plain-language label.</p>`
    }
  };
  const h = hints[which];
  if(!h) return;
  openDrawer({ title: h.title, subtitle: "Definition & interpretation", html: `<div class="section">${h.body}</div>` });
}

/*****************************************************************
 * BOOT
 *****************************************************************/
async function init(){
  $("#drawerClose").addEventListener("click", closeDrawer);
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeDrawer(); });

  $("#openMethods").addEventListener("click", showMethods);
  $("#tabMethods").addEventListener("click", showMethods);
  $("#tabOverview").addEventListener("click", ()=>{
    $("#tabOverview").classList.add("active");
    $("#tabMethods").classList.remove("active");
    closeDrawer();
  });
  $("#tabPrint").addEventListener("click", ()=> window.print());

  $("#openReadingGuide").addEventListener("click", showReadingGuide);
  $("#openTrendNotes").addEventListener("click", showTrendNotes);
  $("#openSkillNotes").addEventListener("click", showSkillNotes);
  $("#openKYOHNotes").addEventListener("click", showKYOHNotes);
  $("#openKYOHNotes2").addEventListener("click", showKYOHNotes);
  $("#openJobCats").addEventListener("click", showJobCategoriesHelp);

  $$(".hint").forEach(h=> h.addEventListener("click", ()=> showHint(h.dataset.hint)));

  $("#forceRefresh").addEventListener("click", ()=>{
    clearCache();
    location.reload();
  });

  $$("#audienceToggle button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      currentAudience = btn.dataset.aud || "all";
      $$("#audienceToggle button").forEach(b=> b.setAttribute("aria-pressed", b.dataset.aud === currentAudience ? "true" : "false"));
      renderAll();
    });
  });

  const shimmer = (w,h)=>`<span class="skel" style="width:${w}px;height:${h}px;"></span>`;
  $("#kAiShare").innerHTML = shimmer(90,28);
  $("#kAiCount").innerHTML = shimmer(70,28);
  $("#kTotalScanned").innerHTML = shimmer(90,28);
  $("#kQuality").innerHTML = shimmer(70,22);

  try{
    blended = await fetchBlend();
    renderAll();
  }catch(err){
    console.error(err);
    const statusEl = $("#blendStatus");
    statusEl.textContent = "error";
    statusEl.className = "bad";
    openDrawer({
      title: "Data fetch error",
      subtitle: "The dashboard could not load market data.",
      html: `
        <div class="section">
          <strong>What to try</strong>
          <ul>
            <li>Verify Worker is live: <code>${escapeHtml(PROXY_BASE)}</code></li>
            <li>Verify LinkedIn route exists: <code>${escapeHtml(PROXY_BASE)}/linkedin</code></li>
            <li>Click <strong>Force refresh</strong> to clear cache.</li>
            <li>If you see rate limits, reduce LinkedIn pages or terms.</li>
          </ul>
          <pre>${escapeHtml(String(err))}</pre>
        </div>
      `
    });
  }
}

init();
</script>
</body>
</html>
